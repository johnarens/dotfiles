/*
 * Copyright (c) 2014 Amazon.com, Inc. All rights reserved.
 */
var goog=goog||{};goog.userAgent=goog.userAgent||{};goog.global=this;goog.string=goog.string||{};goog.string.contains=function(a,f){return a.indexOf(f)!==-1};goog.userAgent.ASSUME_IE=!1;goog.userAgent.ASSUME_GECKO=!1;goog.userAgent.ASSUME_WEBKIT=!1;goog.userAgent.ASSUME_MOBILE_WEBKIT=!1;goog.userAgent.ASSUME_OPERA=!1;goog.userAgent.BROWSER_KNOWN_=goog.userAgent.ASSUME_IE||goog.userAgent.ASSUME_GECKO||goog.userAgent.ASSUME_MOBILE_WEBKIT||goog.userAgent.ASSUME_WEBKIT||goog.userAgent.ASSUME_OPERA;
goog.userAgent.getUserAgentString=function(){return goog.global.navigator?goog.global.navigator.userAgent:null};goog.userAgent.getNavigator=function(){return goog.global.navigator};
goog.userAgent.init_=function(){goog.userAgent.detectedOpera_=!1;goog.userAgent.detectedIe_=!1;goog.userAgent.detectedWebkit_=!1;goog.userAgent.detectedMobile_=!1;goog.userAgent.detectedGecko_=!1;var a;if(!goog.userAgent.BROWSER_KNOWN_&&(a=goog.userAgent.getUserAgentString())){var f=goog.userAgent.getNavigator();if(a.indexOf("Opera")===0)goog.userAgent.detectedOpera_=!0,goog.userAgent.ENGINE="Opera";if(!goog.userAgent.detectedOpera_&&a.indexOf("MSIE")!==-1)goog.userAgent.detectedIe_=!0,goog.userAgent.ENGINE=
"IE";if(!goog.userAgent.detectedOpera_&&a.indexOf("WebKit")!==-1)goog.userAgent.detectedWebkit_=!0,goog.userAgent.ENGINE="WebKit";if(goog.userAgent.detectedWebkit_&&a.indexOf("Mobile")!==-1)goog.userAgent.detectedMobile_=!0;if(!goog.userAgent.detectedOpera_&&!goog.userAgent.detectedWebkit_&&f.product==="Gecko")goog.userAgent.detectedGecko_=!0,goog.userAgent.ENGINE="Gecko"}};goog.userAgent.BROWSER_KNOWN_||goog.userAgent.init_();
goog.userAgent.OPERA=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_OPERA:goog.userAgent.detectedOpera_;goog.userAgent.IE=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_IE:goog.userAgent.detectedIe_;goog.userAgent.GECKO=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_GECKO:goog.userAgent.detectedGecko_;goog.userAgent.WEBKIT=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_WEBKIT||goog.userAgent.ASSUME_MOBILE_WEBKIT:goog.userAgent.detectedWebkit_;
goog.userAgent.MOBILE=goog.userAgent.ASSUME_MOBILE_WEBKIT||goog.userAgent.detectedMobile_;goog.userAgent.SAFARI=goog.userAgent.WEBKIT;goog.userAgent.determinePlatform_=function(){var a=goog.userAgent.getNavigator();return a&&a.platform||""};goog.userAgent.PLATFORM=goog.userAgent.determinePlatform_();goog.userAgent.ASSUME_MAC=!1;goog.userAgent.ASSUME_WINDOWS=!1;goog.userAgent.ASSUME_LINUX=!1;goog.userAgent.ASSUME_X11=!1;
goog.userAgent.PLATFORM_KNOWN_=goog.userAgent.ASSUME_MAC||goog.userAgent.ASSUME_WINDOWS||goog.userAgent.ASSUME_LINUX||goog.userAgent.ASSUME_X11;
goog.userAgent.initPlatform_=function(){goog.userAgent.OS="";if(goog.string.contains(goog.userAgent.PLATFORM,"Mac"))goog.userAgent.detectedMac_=!0,goog.userAgent.OS="Mac";if(goog.string.contains(goog.userAgent.PLATFORM,"Win"))goog.userAgent.detectedWindows_=!0,goog.userAgent.OS="Windows";if(goog.string.contains(goog.userAgent.PLATFORM,"Linux"))goog.userAgent.detectedLinux_=!0,goog.userAgent.OS="Linux";if(goog.userAgent.getNavigator()&&goog.string.contains(goog.userAgent.getNavigator().appVersion||
"","X11"))goog.userAgent.detectedX11_=!0,goog.userAgent.OS="X11"};goog.userAgent.PLATFORM_KNOWN_||goog.userAgent.initPlatform_();goog.userAgent.MAC=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_MAC:goog.userAgent.detectedMac_;goog.userAgent.WINDOWS=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_WINDOWS:goog.userAgent.detectedWindows_;goog.userAgent.LINUX=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_LINUX:goog.userAgent.detectedLinux_;
goog.userAgent.X11=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_X11:goog.userAgent.detectedX11_;
goog.userAgent.determineVersion_=function(){var a="",f;goog.userAgent.OPERA&&goog.global.opera?(a=goog.global.opera.version,a=typeof a==="function"?a():a):(goog.userAgent.GECKO?f=/rv\:([^\);]+)(\)|;)/:goog.userAgent.IE?f=/MSIE\s+([^\);]+)(\)|;)/:goog.userAgent.WEBKIT&&(f=/WebKit\/(\S+)/),f&&(a=(a=f.exec(goog.userAgent.getUserAgentString()))?a[1]:""));return goog.userAgent.IE&&(f=goog.userAgent.getDocumentMode_(),f>parseFloat(a))?String(f):a};
goog.userAgent.getDocumentMode_=function(){var a=goog.global.document;return a?a.documentMode:void 0};goog.userAgent.VERSION=goog.userAgent.determineVersion_();goog.userAgent.isDocumentModeCache_={};goog.userAgent.isDocumentMode=function(a){return goog.userAgent.isDocumentModeCache_[a]||(goog.userAgent.isDocumentModeCache_[a]=goog.userAgent.IE&&document.documentMode&&document.documentMode>=a)};goog.userAgent.product=goog.userAgent.product||{};goog.userAgent.product.ASSUME_FIREFOX=!1;
goog.userAgent.product.ASSUME_CAMINO=!1;goog.userAgent.product.ASSUME_IPHONE=!1;goog.userAgent.product.ASSUME_IPAD=!1;goog.userAgent.product.ASSUME_ANDROID=!1;goog.userAgent.product.ASSUME_CHROME=!1;goog.userAgent.product.ASSUME_SAFARI=!1;
goog.userAgent.product.PRODUCT_KNOWN_=goog.userAgent.ASSUME_IE||goog.userAgent.ASSUME_OPERA||goog.userAgent.product.ASSUME_FIREFOX||goog.userAgent.product.ASSUME_CAMINO||goog.userAgent.product.ASSUME_IPHONE||goog.userAgent.product.ASSUME_IPAD||goog.userAgent.product.ASSUME_ANDROID||goog.userAgent.product.ASSUME_CHROME||goog.userAgent.product.ASSUME_SAFARI;
goog.userAgent.product.init_=function(){goog.userAgent.product.BROWSER_NAME="";goog.userAgent.product.detectedFirefox_=!1;goog.userAgent.product.detectedCamino_=!1;goog.userAgent.product.detectedIphone_=!1;goog.userAgent.product.detectedIpad_=!1;goog.userAgent.product.detectedAndroid_=!1;goog.userAgent.product.detectedChrome_=!1;goog.userAgent.product.detectedSafari_=!1;var a=goog.userAgent.getUserAgentString();if(a)if(a.indexOf("iPhone")!==-1||a.indexOf("iPod")!==-1)goog.userAgent.product.detectedIphone_=
!0,goog.userAgent.product.BROWSER_NAME="iPhone";else if(a.indexOf("iPad")!==-1)goog.userAgent.product.detectedIpad_=!0,goog.userAgent.product.BROWSER_NAME="iPad";else if(a.indexOf("Android")!==-1)goog.userAgent.product.detectedAndroid_=!0,goog.userAgent.product.BROWSER_NAME="Android";else if(a.indexOf("Chrome")!==-1)goog.userAgent.product.detectedChrome_=!0,goog.userAgent.product.BROWSER_NAME="Chrome";else if(a.indexOf("Safari")!==-1)goog.userAgent.product.detectedSafari_=!0,goog.userAgent.product.BROWSER_NAME=
"Safari";else if(a.indexOf("MSIE")!==-1)goog.userAgent.product.detectedIe_=!0,goog.userAgent.product.BROWSER_NAME="IE";else if(a.indexOf("Camino")!==-1)goog.userAgent.product.detectedCamino_=!0,goog.userAgent.product.BROWSER_NAME="Camino";else if(a.indexOf("Firefox")!==-1)goog.userAgent.product.detectedFirefox_=!0,goog.userAgent.product.BROWSER_NAME="Firefox"};goog.userAgent.product.PRODUCT_KNOWN_||goog.userAgent.product.init_();goog.userAgent.product.OPERA=goog.userAgent.OPERA;
goog.userAgent.product.IE=goog.userAgent.IE;goog.userAgent.product.FIREFOX=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_FIREFOX:goog.userAgent.product.detectedFirefox_;goog.userAgent.product.CAMINO=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_CAMINO:goog.userAgent.product.detectedCamino_;goog.userAgent.product.IPHONE=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_IPHONE:goog.userAgent.product.detectedIphone_;
goog.userAgent.product.IPAD=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_IPAD:goog.userAgent.product.detectedIpad_;goog.userAgent.product.ANDROID=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_ANDROID:goog.userAgent.product.detectedAndroid_;goog.userAgent.product.CHROME=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_CHROME:goog.userAgent.product.detectedChrome_;
goog.userAgent.product.SAFARI=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_SAFARI:goog.userAgent.product.detectedSafari_;goog.userAgent.platform=goog.userAgent.platform||{};goog.userAgent.platform.determineVersion_=function(){var a;if(goog.userAgent.WINDOWS)return a=/Windows NT ([0-9.]+)/,(a=a.exec(goog.userAgent.getUserAgentString()))?a[1]:"0";else if(goog.userAgent.MAC)return a=/10[_.][0-9_.]+/,(a=a.exec(goog.userAgent.getUserAgentString()))?a[0].replace(/_/g,"."):"10";return""};
goog.userAgent.platform.VERSION=goog.userAgent.platform.determineVersion_();
goog.userAgent.product.determineVersion_=function(){var a="",f,d;if(goog.userAgent.product.FIREFOX)f=/Firefox\/([0-9.]+)/;else if(goog.userAgent.product.IE||goog.userAgent.product.OPERA)return goog.userAgent.VERSION;else goog.userAgent.product.CHROME?f=/Chrome\/([0-9.]+)/:goog.userAgent.product.SAFARI?f=/Version\/([0-9.]+)/:goog.userAgent.product.IPHONE||goog.userAgent.product.IPAD?(f=/Version\/(\S+).*Mobile\/(\S+)/,d=!0):goog.userAgent.product.ANDROID?f=/Android\s+([0-9.]+)(?:.*Version\/([0-9.]+))?/:
goog.userAgent.product.CAMINO&&(f=/Camino\/([0-9.]+)/);f&&(a=(a=f.exec(goog.userAgent.getUserAgentString()))?d?a[1]+"."+a[2]:a[2]||a[1]:"");return a};goog.userAgent.product.VERSION=goog.userAgent.product.determineVersion_();var GoogleUserAgent=function(){return{browserName:goog.userAgent.product.BROWSER_NAME,osName:goog.userAgent.OS,engineName:goog.userAgent.ENGINE,browserVersionString:goog.userAgent.product.VERSION,engineVersionString:goog.userAgent.VERSION,isMobile:goog.userAgent.MOBILE}}();
function AppCacheEventProvider(a){function f(){l=!1;m=-1;o.done(function(){});KindleBuildInfo.getCurrentTotalAppcacheFileCount().then(o.resolve,o.reject)}function d(a,b,c){function d(){k.callEventListeners(a,b)}o.then(d,d);c&&(l=!0,o=jQuery.Deferred())}function b(a){l&&f();d("checking",a,!1)}function c(a){l&&f();m+=1;if(a.total!==void 0&&a.loaded!==void 0)o.resolve(a.total+1),k.callEventListeners("progress",a);else{var b=function(){a.loaded=m;return function(b){a.total=b===-1?-1:b-1;k.callEventListeners("progress",
a)}}();o.then(b,b)}}var k=ListenerManager(),m=-1,l=!0,o;o=jQuery.Deferred();(function(){typeof a.addEventListener==="function"&&(a.addEventListener("error",function(a){d("error",a,!0)}),a.addEventListener("cached",function(a){d("cached",a,!0)}),a.addEventListener("noupdate",function(a){d("noupdate",a,!0)}),a.addEventListener("updateready",function(a){d("updateready",a,!0)}),a.addEventListener("downloading",function(a){d("downloading",a,!1)}),a.addEventListener("checking",b,!1),a.addEventListener("progress",
c,!1))})();var s={status:0,abort:a.abort,update:a.update,swapCache:a.swapCache,addEventListener:k.addEventListener,removeEventListener:k.removeEventListener};$.extend(s,CreateAppCacheConstants());return s}function CreateAppCacheConstants(){var a={};["CHECKING","DOWNLOADING","IDLE","OBSOLETE","UNCACHED","UPDATEREADY"].forEach(function(f){a[f]=window.applicationCache[f]});return a}
var KindleAppCacheEventHandler=function(){function a(){u={timer:_metricsManager.createTimer(),loaded:0,total:0}}function f(){a()}function d(){KindleHostDeviceDetector.isNetworkAvailableSync()?(n.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RestartBrowserFailed",{breakdown:["Browser"]}):q.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RetryFailed",{breakdown:["Browser"]}):u.timer.emit("KindleApp:AppCacheError:FirstTime",{breakdown:["Browser"]}),u.timer.emit("KindleApp:AppCacheError",
{submetrics:[{name:"progress",value:u.total}],breakdown:["Browser"]}),KindleHostDeviceDetector.isiOS_4x()&&u.loaded===u.total&&q.getValue()>=1?(l(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART),n.increment(),_metricsManager.emit("KindleApp:AppCacheError:SafariRebootPrompt",{breakdown:["Browser"]})):(l(Kindle.APP_CACHE.CACHE_NEEDS_RETRY),q.increment(),_metricsManager.emit("KindleApp:AppCacheError:RetryPrompt",{breakdown:["Browser"]})),KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.isOnline()&&
h==="CHECKING"&&KindleLocalStorage.getItem("cached")&&(_metricsManager.emit("KindleApp:AppCacheError:OnlineInstafail",{breakdown:["Browser"]}),KindleLocalStorage.setItem("cached",0),KindleHostDeviceDetector.isiOSAppMode()&&(_metricsManager.emit("KindleApp::iOSAppModeAppCacheFix"),KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).register())),h=""):l(Kindle.APP_CACHE.CACHE_DONE)}function b(b){u===null&&a();l(Kindle.APP_CACHE.CACHE_PROGRESS,{progressRatio:b.total?b.loaded+1/b.total+
1:0});h="";u.loaded=b.loaded+1;u.total=b.total+1}function c(){n.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RestartBrowserSucess",{breakdown:["Browser"]}):q.getValue()>0&&_metricsManager.emit("KindleApp:AppCacheError:RetrySucess",{breakdown:["Browser"]});q.reset();n.reset()}function k(){h="";l(Kindle.APP_CACHE.CACHE_DONE);c();u.timer.emit("KindleApp:AppCacheUpdate",{submetrics:[{name:"progress",value:u.loaded}],breakdown:["Browser"]})}function m(){h="";l(Kindle.APP_CACHE.CACHE_CACHED);
KindleLocalStorage.getItem("cached")||KindleLocalStorage.setItem("cached",1);c();u&&u.loaded&&u.timer.emit("KindleApp:AppCacheSuccess",{submetrics:[{name:"progress",value:u.loaded}],breakdown:["Browser"]})}function l(a,b){b||(b={});v=a;s.callEventListeners(a,b)}var o,s=ListenerManager(),h="",u=null,q,n,v;return{initialize:function(a,c,l){_metricsManager=c;typeof Kindle==="undefined"&&(Kindle=l);q=LocalStorageCounter("AppCacheRetryCount");n=LocalStorageCounter("AppCacheBrowserRestartCount");o=a;h=
["UNCACHED","IDLE","CHECKING","DOWNLOADING","UPDATE READY","OBSOLETE"][o.status];try{o.addEventListener("checking",f,!1),o.addEventListener("error",d,!1),o.addEventListener("progress",b,!1),o.addEventListener("cached",m,!1),o.addEventListener("noupdate",m,!1),o.addEventListener("updateready",k,!1)}catch(s){}},getCacheStatus:function(){return v},removeEventListener:function(a,b){s.removeEventListener(a,b)},addEventListener:function(a,b,c){s.addEventListener(a,b,c)}}}(),KindleAppCacheManager=function(){function a(a){if(KindleHostDeviceDetector.isiOS_4x()||
KindleHostDeviceDetector.isFirefox())a=AppCacheEventProvider(a);try{KindleAppCacheEventHandler.initialize(a,k,m),d.resolve(KindleAppCacheEventHandler)}catch(b){d.reject()}}function f(l,o){k=l;m=o;d=$.Deferred();c?b||(b=$(document.createElement("iframe")).attr("seamless",!0).css("display","none").css("visibility","hidden").attr("src",KINDLE_APPCACHER_SRC)[0],$(document.body).append($(b)),KindleDebug.log("AppCacheIframe created")):a(window.applicationCache);return d.promise()}var d,b,c,k,m;return{initialize:function(a){var b=
[KindleModuleManager.METRICS_MANAGER,KindleModuleManager.CONSTANTS];(c=KindleHostDeviceDetector.isFirefox()&&window.applicationCache.status!==window.applicationCache.UNCACHED)&&b.push(a);KindleModuleManager.define(Kindle.MODULE.APPCACHE_EVENTHANDLER,b,f)},connectIframeAppCache:a}}();
Kindle.URL=function(){function a(){return window.location.host.split(".")[0].indexOf("read-")!==-1}function f(){return window.location.protocol+"//"+window.location.hostname+window.location.port+window.location.pathname}function d(a){for(var b={},a=a.split("&"),c=0;c<a.length;c++){var d;d=a[c].split("=");var o=d[0],h="";d.length>1&&(h=d[1]);d={key:o,value:h};d.key&&(b[d.key]=decodeURIComponent(d.value))}return b}function b(a){var b=a;a.indexOf("?")===0&&a.length>1&&(b=a.substring(1));return b}function c(a){var b=
"";a&&(b+="?"+a);return b}function k(a){var b={},c;for(c in a)h.indexOf(c)>-1&&(b[c]=a[c]);return b}function m(a){var b=o();b.hasOwnProperty(a)&&delete b[a];a=$.param(b);a=c(a);l(a)}function l(a){a=window.location.protocol+"//"+window.location.hostname+window.location.port+window.location.pathname+a+window.location.hash;if(window.history.replaceState)try{window.history.replaceState(document.title,document.title,a)}catch(b){}}function o(){var a={},c=window.location.search;c&&(a=b(c),a=d(a));return a=
k(a)}function s(){var a=o(),b=a[u];if(b){var b=decodeURIComponent(b),b=d(b),c;for(c in b)a[c]=b[c];delete a[u]}return a}var h=["srsBasePath","usePdxBucket","key","version","maxDBSize","ref_","siteState","kcrFree","autoHide","tag","language","lang","stringIDMode","region","host","hostVersion","clear","asin","library","ip","rwis"],u="siteState",q;return{normalizeQueryString:function(){var a=s(),a=$.param(a),a=c(a);l(a)},removeQueryParameter:m,removeAllQueryParameters:function(){var a=o(),b;for(b in a)a.hasOwnProperty(b)&&
m(b)},removeASIN:function(){m("asin")},addSavedStateToQueryParameters:function(){var a=s();if(q)for(var b in q)a[b]=q[b];a=$.param(a);a=c(a);l(a)},getQueryParameters:o,getFragIdParameters:function(){var a={};window.location.hash.length>0&&window.location.hash.substring(1).split("&").forEach(function(b){b=b.split("=");b.length===2&&(a[b[0]]=decodeURIComponent(b[1]))});return a=k(a)},getBaseURL:f,getHostURL:function(){return window.location.protocol+"//"+window.location.hostname+window.location.port},
getBasePathURL:function(){return f().replace(/[^\/]*\.html$/,"")},getSiteState:function(){var a="",c=window.location.search,c=c||"",d;for(d in q)c&&(c+="&"),c+=d+"="+q[d];c&&(c=b(c),d=encodeURIComponent(c),a+=u+"="+d);return a},addToSavedSiteState:function(a){q||(q={});for(var b in a)q[b]=a[b]},getAmazonDomain:function(){var a=/^.*\.(amazon(\.[^.]*){1,2})$/.exec(window.location.host);return a!==null?a[1]:null},isJPDomain:function(){return Kindle.URL.isPreProd()?Kindle.URL.getPreProdCountryCode()===
"jp":Kindle.URL.getAmazonDomain()===Kindle.CountryToDomainMap.jp},isPreProd:a,getPreProdCountryCode:function(){if(a()){var b=window.location.host.split(".")[0],b=b.substr(b.length-3);if(b.charAt(0)==="-")return b.substr(1,2)}return""}}}();
function KindleAppFactory(){function a(){return!!G}function f(){return window.self!==window.top&&!G}function d(){aa||(aa=c(U.KINDLE_READER_ID,KINDLE_READER_SRC,"#"+U.KINDLE_READER_CONTAINER_ID))}function b(){ba||(ba=c(U.KINDLE_LIBRARY_ID,KINDLE_LIBRARY_SRC,"#"+U.KINDLE_LIBRARY_CONTAINER_ID))}function c(g,a,b){if(!KindleHostDeviceDetector.isMetro()&&a[0]==="."){var p=Kindle.top.location.href;p.slice(-1)!=="/"&&(p=p.slice(0,p.lastIndexOf("/")+1));a=p+a.slice(2)}g=$(document.createElement("iframe")).attr("id",
g).attr("seamless","seamless").addClass(pa);KindleHostDeviceDetector.isIE()||g.attr("src",a);$(b).append(g);KindleHostDeviceDetector.isIE()&&g[0].contentWindow.location.replace(a);return g}function k(g){if(g)g.readerClass?x.readerClass=g.readerClass:delete x.readerClass,g.readerAppBar?x.readerAppBar=g.readerAppBar:delete x.readerAppBar,g.cacheSample?x.cacheSample=g.cacheSample:delete x.cacheSample,g.returnToLibrary?x.returnToLibrary=g.returnToLibrary:delete x.returnToLibrary,g.position?(x.position=
Number(g.position),delete x.location):g.location?(x.location=Number(g.location),delete x.position):(delete x.position,delete x.location),x.asin=g.asin,g.isSample!==void 0?x.isSample=g.isSample?!0:!1:delete x.isSample,g.hostStorage===!0?x.contentProvider=n(x.asin):delete x.contentProvider;x.closeButton=f()?Kindle.Reader.CloseButtonNone:Kindle.Reader.CloseButtonAuto;x.standAlone=ba===void 0;x.asin&&H&&(H.openBook(x),KindleBanner.changeBookCover(x.asin),aa&&aa.focus(),x.standAlone&&$("#"+U.KINDLE_READER_CONTAINER_ID).removeClass("hidden"))}
function m(g){x.asin=void 0;KindleLocalStorage.setItem(X,"");Kindle.URL.removeASIN();H&&(H.unloadReader(),H=null);$("#"+U.KINDLE_READER_CONTAINER_ID).addClass("hidden").empty();aa=void 0;g&&(fa=g);if(S)S.onReaderClose()}function l(){console.log("hiding library");ga=setTimeout(function(){$("#"+U.KINDLE_LIBRARY_CONTAINER_ID).addClass("hidden")},3E3)}function o(){console.log("hiding reader");H&&H.pauseReader();$("#"+U.KINDLE_READER_CONTAINER_ID).addClass("hidden");ga&&(clearTimeout(ga),ga=void 0);$("#"+
U.KINDLE_LIBRARY_CONTAINER_ID).removeClass("hidden");ba&&ba.focus();if(S!==null)S.onShowLibrary()}function s(){fa&&(KindleMetricsManager.endMetrics(fa),fa=null);d()}function h(){var g=KindleHostDeviceDetector.isInAppMode()?"inApp":"inBrowser",a=x.asin?"inReader":"inLibrary",p=KindleHostDeviceDetector.isOnline()?"online":"offline",g={submetrics:[{name:g,value:1},{name:a,value:1},{name:p,value:1}],breakdown:["Browser","Partner"]};KindleMetricsManager.emit("App::Open",g);f()&&KindleMetricsManager.emit("App::Open::Embedded",
g);x.kcrFree&&KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(g){g=g.getAuthenticationState();KindleMetricsManager.emit("App::Open::"+g)})}function u(){H&&H.unloadReader();KindleModuleManager.require(Kindle.MODULE.DB_CLIENT).done(function(g){g.persistDB()})}function q(){var g,a=!0;!KindleHostDeviceDetector.isCookieEnabled()&&!x.kcrFree?(g=KINDLE_NO_COOKIE_SRC,a=!1):!KindleHostDeviceDetector.isLocalStorageEnabled()&&!x.kcrFree&&(g=KINDLE_NO_LOCAL_STORAGE_SRC,a=!1);a||
(g=$(document.createElement("iframe")).attr("src",g).addClass(pa).attr("seamless","seamless"),$("body").append(g));return a}function n(g){return RemoteContentCache.create({asin:g,contentProvider:G.contentProvider,contentRemover:G.deleteBookContent})}function v(){function g(p){KindleAppCacheEventHandler.addEventListener(p,function(){if(KindleHostDeviceDetector.isOnline())switch(p){case Kindle.APP_CACHE.CACHE_NEEDS_RETRY:G.onAppCacheStatus("error");a=!1;break;case Kindle.APP_CACHE.CACHE_PROGRESS:a||
(G.onAppCacheStatus("incomplete"),a=!0);break;case Kindle.APP_CACHE.CACHE_DONE:case Kindle.APP_CACHE.CACHE_CACHED:G.onAppCacheStatus("success");if(window.applicationCache.status===window.applicationCache.UPDATEREADY)G.onAppCacheUpdateReady();a=!1}})}var a=!1;g(Kindle.APP_CACHE.CACHE_NEEDS_RETRY);g(Kindle.APP_CACHE.CACHE_PROGRESS);g(Kindle.APP_CACHE.CACHE_DONE);g(Kindle.APP_CACHE.CACHE_CACHED)}function w(){function g(a,p){function b(g){var p=e.elementFromPoint(g.pageX,g.pageY);return e.createTouch(a,
p,g.identifier,g.pageX,g.pageY,g.screenX,g.screenY)}function j(g){for(var a=[],p=0;p<g.length;p++)a.push(b(g[p]));return e.createTouchList.apply(e,a)}var e=a.document,r=e.createEvent("TouchEvent",{bubbles:!0});r.initTouchEvent(p.type,p.bubbles,p.cancelable,a,p.detail,p.screenX,p.screenY,p.clientX,p.clientY,p.ctrlKey,p.altKey,p.shiftKey,p.metaKey,j(p.touches),j(p.targetTouches),j(p.changedTouches),p.scale,p.rotation);return r}function a(){return function(g){KindleTOS.proxyTouchEvent(g);g.preventDefault()}}
function p(a){return function(p){var b=a.querySelectorAll(".KindleIFrame");KindleAssert(b.length===1,"Expecting exactly one iFrame");var e=b[0],b=e.contentDocument,e=g(e.contentWindow,p);if(b=b.elementFromPoint(p.changedTouches[0].clientX,p.changedTouches[0].clientY))b.dispatchEvent(e),e.defaultPrevented&&p.preventDefault()}}document.addEventListener("touchmove",function(g){g.preventDefault()},!1);var b=["touchstart","touchmove","touchend","touchcancel"],j,e,r;if(KindleHostDeviceDetector.isiOS_8x()&&
KindleHostDeviceDetector.isInAppMode()){j=document.querySelectorAll(".touchproxy");for(e=0;e<j.length;e++)for(r=0;r<b.length;r++)j[e].addEventListener(b[r],p(j[e],0));j=document.querySelectorAll(".touchbhproxy");for(e=0;e<j.length;e++)for(r=0;r<b.length;r++)j[e].addEventListener(b[r],a(j[e]))}}function C(){KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseI18NSupported(V,x.language)?B("langSupport"):KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseVersionNonSupported(V)&&B();KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseCountryNotSupported(V,
x.language,x.ip).done(function(g){g&&B("countryBlk")})}function B(g){if(G){var a=Kindle.URL.getBasePathURL();a.indexOf("k4w")===-1&&(a=Kindle.URL.getHostURL()+"/");var p=KINDLE_UPGRADE_SRC.substr(1+KINDLE_UPGRADE_SRC.indexOf("/")),b=x.language||KindleHostDeviceDetector.getBrowserLanguage();a+=p+"?language="+b;a+=g?"&type="+g:"";G.showWebPage({url:a})}}function F(){var g,a,p;if(!G){p="library";if(x.hasOwnProperty("library"))KindleLocalStorage.removeItem(X),Kindle.URL.removeQueryParameter("library");
else if(x.asin)p="book";else if(x.clear)Kindle.URL.removeQueryParameter("clear");else if(a=KindleLocalStorage.getItem(X))try{g=JSON.parse(a);if(g.isSample!==void 0)x.isSample=g.isSample;if(g.type==="reader")p="book",x.asin=g.asin}catch(e){x.asin=a}p==="library"&&(b(),o())}d();h()}function I(g,a){var p=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(b){KindleHostDeviceDetector.isOnline()?b.getOwnedContent(g,a).then(p.resolve,p.reject):p.reject("offline")},
p.reject);return p.promise()}function E(){return{setLoginParameters:function(g){e(g)},setFocusToReader:function(){H&&H.setFocus()},showAppbar:function(){H&&H.setToolbarVisible(!0)},hideAppbar:function(){H&&H.setToolbarVisible(!1)},toggleAppbar:function(){H&&H.toggleToolbar()},openBook:function(g){x.asin&&(m(),d());k(g)},goTo:function(g){H&&(g.position>=0?H.goToPosition(g.position):g.location>=0&&H.goToLocation(g.location))},deregister:function(){return ca(!1,!0)},clearDatabases:function(){return KindleModuleManager.require(Kindle.MODULE.DB_CLIENT).pipe(function(g){return g.clear()})},
clearLocalStorage:function(){KindleLocalStorage.clear();return $.Deferred().resolve({success:!0}).promise()},sendMetrics:function(g){g.metrics.method?KindleMetricsManager.emit(g.metrics.method,g.metrics):KindleMetricsManager.emit(g.metrics)},sendMetricsNow:function(g){g.metrics.method?KindleMetricsManager.emitNow(g.metrics.method,g.metrics):KindleMetricsManager.emitNow(g.metrics)},getOwnedContent:function(g){return I(g&&g.lastSyncTime||null,g&&g.reason||null)},requestDeviceName:function(){KindleDebug.warn("requestDeviceName not implemented yet (waiting for new service api)")},
requestDownloadedBookList:function(){return y()},getDownloadedBookInfo:function(g){return z(g)},downloadBook:function(g){D(g)},cancelBookDownload:function(){H&&H.cancelBookDownload()},removeBook:function(g){var a=$.Deferred();H?H.removeBook(g,a.resolve,a.reject):a.reject();return a.promise()},removeBookOwnership:function(g){return K(g)},getSearchContext:function(g){return H?H.getSearchContext(g):$.Deferred().reject()},requestOemAssociateId:function(g){var a=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(p){p.getOemAssociateId(g).then(a.resolve,
a.reject)},a.reject);return a.promise()},getTodoItems:function(g){var a=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(p){p.getTodoItems(g).then(a.resolve,a.reject)},a.reject);return a.promise()},removeTodoItems:function(g){var a=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(p){p.removeTodoItems(g).then(a.resolve,a.reject)},a.reject);return a.promise()},uploadSnapshot:function(g){var a=jQuery.Deferred();
KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(p){p.uploadSnapshot(g).then(a.resolve,a.reject)},a.reject);return a.promise()},getSearchIndex:function(g){return KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).pipe(function(a){return a.getSearchIndexInfo(g)})},getSelectedText:function(g){return H.getSelectedText(g)},hideContextMenu:function(){H.hideContextMenu()},setServiceHost:function(g){KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).done(function(a){a.setServiceHost(g)})},
uploadJournal:function(){return KindleModuleManager.getModule(KindleModuleManager.JOURNAL_MANAGER).pipe(function(g){return g.uploadJournal()})},setStoreCookies:function(g){var a=$.Deferred();try{for(var p=0;p<g.length;p++)document.cookie=g[p].value;setTimeout(a.resolve,0);return a.promise()}catch(b){return a.reject(b)}},updateAppCache:function(){window.applicationCache.update()},getTOSParams:function(g){var a=$.Deferred(),g=g||{};g.width=g.hasTouch?1366:2560;g.height=g.hasTouch?768:1440;g.dpi=g.hasTouch?
148:72;return a.resolve({cachePollAttemptInterval:18E5,cachePollWaitAfterSuccess:432E5,width:g.width,height:g.height,dpi:g.dpi}).promise()},moveAsinToHost:function(g){return KindleModuleManager.getModule(KindleModuleManager.CONTENT_MIGRATION).pipe(function(a){return a.moveBook(g)})},notifyMigrationStatus:function(g){return KindleModuleManager.getModule(KindleModuleManager.CONTENT_MIGRATION).pipe(function(a){return a.notifyMigrationStatus(g)})},convertPositions:function(g){if(H)return H.convertPositions(g)},
updateAnnotations:function(g){if(H)return H.updateAnnotations(g)},updateReaderChrome:function(g){if(H)return H.updateReaderChrome(g)},pingNA:function(){return KindleNetwork.pingNA()},getUrlForPfm:function(g){var a=new $.Deferred,p="";g&&g.method&&g.pfm&&Kindle.PFMLinks[g.pfm]&&(p=Kindle.PFMLinks[g.pfm][g.method]);return a.resolve({url:p})}}}function K(g){return KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).pipe(function(a){return a.removeOwnership(g.asin,g.contentType)})}function y(){var g=
jQuery.Deferred();KindleModuleManager.getModuleList([KindleModuleManager.DB_CLIENT]).then(function(a){(a=a[KindleModuleManager.DB_CLIENT].getAppDb())&&a.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(g.resolve,g.reject)},g.reject);return g.promise()}function z(g){function a(b){var e,j,r={asin:g.asin};b.context=b.context||{};b.metadata=b.metadata||{};for(e in g)e!=="asin"&&g.hasOwnProperty(e)&&(j=b[e]||b.context[e]||b.metadata[e],j!==void 0&&(r[e]=j));p.resolve(r)}var p=jQuery.Deferred();
KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).then(function(b){b.getBookDb().BookInfoDB(g.asin).getBookInfo().then(a,p.reject)},p.reject);return p.promise()}function D(g){function a(){G.onBookDownloadComplete({asin:g.asin})}function p(a){G.onBookDownloadFailed({asin:g.asin,error:a})}function b(a){if(a!==g.prevPct)g.prevPct=a,G.onBookDownloadProgress({asin:g.asin,pct:a})}if(H){if(g.hostStorage===!0)g.contentProvider=n(g.asin);g.prevPct=0;H.downloadBook(g,b,a,p)}}function j(){k()}function t(g){var a=
g&&g.canOpen,p=g&&g.errorCode,g=g&&g.subErrorCode;KindleTOS.setOpenBookReady();ka();a?($("#"+U.KINDLE_READER_CONTAINER_ID).removeClass("hidden"),l()):r();if(S)S.onReaderOpenStatus(a,p,g)}function r(g){m(g);b();o()}function L(g){if(g){g={asin:x.asin,type:"reader"};if(x.isSample!==void 0)g.isSample=x.isSample;KindleLocalStorage.setItem(X,JSON.stringify(g))}}function e(g){var a={hostApp:N(),hostVersion:V,loginParams:g};KindleModuleManager.define(Kindle.MODULE.SERVICE_INITIALIZATION_ARGS,[],function(){return a})}
function A(g){function a(){Kindle.URL.addSavedStateToQueryParameters();window.location.reload(!0)}switch(g.newState){case Kindle.Service.AuthOK:ha.resolve();break;case Kindle.Service.AuthError:g.prevState===Kindle.Service.AuthOK?ca(!0):ia();break;case Kindle.Service.AuthUserMismatch:KindleMetricsManager.emitNow("Service::ClientHashMismatch",{breakdown:["Browser"]});qa().always(a);break;case Kindle.Service.AuthTokenMismatch:a()}}function N(){return G?{onServiceAuthState:G.onServiceAuthState,getRequestSigningHeaders:G.getRequestSigningHeaders}:
{onServiceAuthState:A,getRequestSigningHeaders:function(){KindleDebug.error("Non-Embedded applications do not use signed request headers.")}}}function P(){function g(p){var b={version:"1.0",clientName:x.kcrFree?Kindle.ClientName.KCRFree:KindleHostDeviceDetector.getClientName(),devicePlatform:a,marketplace:Kindle.DomainToCountryMap[Kindle.URL.getAmazonDomain()]},p={uploadCallback:KindleModuleManager.getModuleSync(Kindle.MODULE.METRICS_UPLOADER).uploadMetrics,platformContext:b,dbClient:p,logger:KindleDebug,
isOnline:KindleHostDeviceDetector.isOnline,isNumber:isNumber,persistMetrics:!!p};KindleMetricsManager.initialize(p)}var a=KindleHostDeviceDetector.getDeviceType()+":"+KindleHostDeviceDetector.getDevicePlatform();g();KindleMetricsManager.setBreakdown("Version",KindleVersion.getMetricsVersionString());da()&&KindleMetricsManager.setBreakdown("Partner",da());KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(a){g(a)})}function M(){KindleModuleManager.define(Kindle.MODULE.APPLICATION_ARGS,
[],x);KindleDBClient.initialize();if(!G){var g={};g.srsBasePath=x.srsBasePath;g.usePdxBucket=x.usePdxBucket;e(g)}KindleModuleManager.registerModuleWithDeferred(KindleModuleManager.JOURNAL_MANAGER,KindlJournalManager.initialize());g=KindleUserAgentMetricsInfo.browserWithVersionString();G&&KindleHostDeviceDetector.isMetro()&&(ContentMigration.initialize(),g=V);KindleMetricsManager.setBreakdown("Browser",g);KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(){Y=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);
G&&Y.emit("zzz::HostVersion_"+V+"_kcr@"+KindleVersion.getMetricsVersionString())}).fail(function(){KindleDebug.error("metricsManagerInitializeError: Can not initialize metrics manager")})}function Q(g){var a;a={};if(da())a.tag=da();if(x.kcrFree)a.kcrFree=!0;if(g.refTag)a.refTag=g.refTag;if(a.asin=g.asin){KindleLocalStorage.removeItem(X);if(!a.refTag)a.refTag=g.from===Kindle.SampleToDetailPageButton.Close?Kindle.RefTag.Values.StoreSampleClose:Kindle.RefTag.Values.StoreSample;Kindle.URL.isJPDomain()?
(a="http://www.amazon.co.jp/dp/"+g.asin+"?ref="+a.refTag,W(a,g.openInNewTab)):LinkUrls.getDetailPage(a).then(function(a){W(a,g.openInNewTab||f())})}else Kindle.URL.isJPDomain()?(a=a.refTag?"&ref_="+a.refTag:"",W("http://www.amazon.co.jp/b?node=2275256051"+a,g.openInNewTab)):(a.refTag=a.refTag||Kindle.RefTag.Values.StoreLibButton,LinkUrls.getStoreUrl(a).then(function(a){W(a,g.openInNewTab||f())}))}function J(a,p){var b=Y.startMetrics("Store::TOSOpen"),p=$.extend({storeStartTime:Date.now()},p),e=a===
Z.LIBRARY?S&&S.onStoreOpenStatus:H&&H.onStoreOpenStatus;ja||(ja=!0,KindleTOS.open(p).then(function(p){e&&e(Kindle.STORE.OPEN_STORE);p?KindleLocalStorage.removeItem(X):(a!==Z.LIBRARY&&(m(),d()),l(),ka(),KindleTOS.setStoreClosedCallback(g));Y.endMetrics(b);ja=!1},function(){e&&e(Kindle.STORE.GENERIC_ERROR);Y.modifyMetricsMethod(b,"Store::TOSOpenFail");Y.endMetrics(b);ja=!1}))}function O(){var g=!!x.storePath,a=Kindle.PFMLinks[la]?Kindle.PFMLinks[la].country==="US":!1;return!f()&&Kindle.URL.getAmazonDomain()===
Kindle.CountryToDomainMap.us&&a&&(KindleHostDeviceDetector.isiOS()||g)}function R(g,a){var p=g===Z.LIBRARY?S&&S.onStoreOpenStatus:H&&H.onStoreOpenStatus;!KindleHostDeviceDetector.isOnline()&&p?p(Kindle.STORE.OFFLINE_ERROR):O()?J(g,a):(a.openInNewTab=a.openInNewTab||KindleHostDeviceDetector.isiOS(),Q(a),p&&p(Kindle.STORE.OPEN_STORE))}function T(g){g=Kindle.URL.getBaseURL()+"?asin="+g.asin;W(g,f())}function g(){x.asin?(d(),p(1E3)):(b(),o(),S&&S.libraryUpdateNeeded())}function p(g){ma=setTimeout(function(){ea&&
($("body").append(ea),ea=null);var g=$("#loading_spinner"),a=$(window).width(),p=parseInt(g.css("width"),10),b=$(window).height(),e=parseInt(g.css("height"),10);g.css("top",(b-e)/2+"px").css("left",(a-p)/2+"px").show()},g)}function ka(){ma&&clearTimeout(ma);var g=$("#loading_spinner").detach();g.length&&!ea&&(ea=g)}function W(g,a){if(G)KindleDebug.error("Tried to go to a different URL when we are hosted");else if(a&&KindleHostDeviceDetector.isiOS()&&window.navigator.standalone){var p=document.createElement("a");
p.href=g;p.target="_blank";var b=document.createEvent("MouseEvents");b.initEvent("click",!0,!0);p.dispatchEvent(b)}else a?window.open(g):window.location=g}function ia(){return KindleRegistrationHandler.register()}function ca(g,a){return KindleRegistrationHandler.deregister(g,a).then(function(){if(G&&G.onDeregister)G.onDeregister(!0)},function(){if(G&&G.onDeregister)G.onDeregister(!1)})}function qa(){KindleLocalStorage.clear();return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).clear()}
function da(){return x.tag}function ra(){$(window).height()!==sa&&(sa=$(window).height(),$(window).trigger("resize"),window.scrollTo(0,0));setTimeout(ra,1E3)}var U={KINDLE_READER_ID:"KindleReaderIFrame",KINDLE_READER_CONTAINER_ID:"KindleReaderContainer",KINDLE_LIBRARY_ID:"KindleLibraryIFrame",KINDLE_LIBRARY_CONTAINER_ID:"KindleLibraryContainer",KINDLE_STORE_CONTAINER_ID:"KindleStoreContainer"},Z={LIBRARY:"fromLibrary",READER:"fromReader"},na,la="",pa="KindleIFrame",X="last_app_activity",aa,ba,x={},
H=null,S=null,fa,ja=!1,ga,ma,ea,Y,oa,V,G,ha,sa=$(window).height,ta=!1;return{initialize:function(){if(!ta){ta=!0;KindleHostDeviceDetector.isiOSAppMode()||(Kindle.URL.normalizeQueryString(),x=$.extend({},Kindle.URL.getFragIdParameters(),Kindle.URL.getQueryParameters()));ka();na=[Kindle.MODULE.APPCACHE_EVENTHANDLER,KindleModuleManager.RESOURCE_BUNDLE,KindleModuleManager.DB_CLIENT,KindleModuleManager.METRICS_MANAGER,KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.CONSTANTS,KindleModuleManager.NETWORK,
KindleModuleManager.JOURNAL_MANAGER,KindleModuleManager.LINK_URLS];KindleModuleManager.registerModule(KindleModuleManager.CONSTANTS,Kindle);KindleModuleManager.registerModule(KindleModuleManager.RESOURCE_BUNDLE,ResourceBundle);KindleModuleManager.registerModule(KindleModuleManager.NETWORK,KindleNetwork);KindleModuleManager.registerModule(KindleModuleManager.METRICS_MANAGER,KindleMetricsManager);KindleModuleManager.registerModule(KindleModuleManager.LINK_URLS,LinkUrls);ResourceBundle.setStringIDMode(!!x.stringIDMode);
ResourceBundle.initialize(x.language||x.lang,x.region);KindleTemplateManager.initialize();KindleStreamingReaderClient.initialize();P();w();document.title=ResourceBundle.getLocalizedString("k_window_title");ha=new jQuery.Deferred;KindleAppCacheManager.initialize(ha);KindleHostDeviceDetector.isiOS()&&$("body").addClass("ipad");if(KindleHostDeviceDetector.hasiOSInnerHeightBug())window.onresize=function(){window.scrollTo(0,0)},$("body").addClass("iosInnerHeightBug");if(KindleHostDeviceDetector.isSafari(6.1))$(document).on("mousewheel",
function(){});KindleDeviceCapabilities.hasPageResizeIssues()&&ra();if(q()){window.onbeforeunload=u;if(x.host){if(!KindleHostDeviceDetector.isMetro()||!/^(ms-appx:\/\/)?amznmobilellc.kindleforwindows8$/.test(x.host)){console.error("unknown embedded host: "+x.host);return}oa=x.host;V=x.hostVersion;G=ReaderHostInterfaceFactory(E(),oa);KindleModuleManager.define(KindleModuleManager.EMBEDDED_HOSTINTERFACE,[],G);Kindle.URL.removeQueryParameter("host");C();G.onReaderLoaded({readerVersion:KindleVersion.getVersionString(),
sendCrashWVMetricsVersions:[]});v();KindleHostDeviceDetector.isMetro()&&KindleModuleManager.getModuleList([KindleModuleManager.DB_CLIENT]).then(function(g){g[KindleModuleManager.DB_CLIENT].enableFullDb().then(function(){KindleDebug.log("In metro mode, enabling full database")},function(){KindleDebug.error("In metro mode, was not able to enable full database.")})})}if(x.ref_)if(Kindle.RefTag.isRWISRefTag(x.ref_)){var a=x.ref_,p=x.asin?x.asin:"";Kindle.URL.addToSavedSiteState(x);Kindle.URL.removeAllQueryParameters();
KindleBanner.showRWISBanner(a,p)}else Kindle.URL.addToSavedSiteState({ref_:x.ref_}),Kindle.URL.removeQueryParameter("ref_");x.tag&&(Kindle.URL.addToSavedSiteState({tag:x.tag}),Kindle.URL.removeQueryParameter("tag"));if(x.kcrFree&&!x.asin)x.asin=Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED;M();x.storePath&&KindleTOS.setStoreURL(decodeURIComponent(x.storePath));KindleTOS.setOpenBookCallback(k);KindleTOS.setStoreClosedCallback(g);if(x.kcrFree)F();else{var b;KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).pipe(function(g){b=
g;return g.authenticate()}).pipe(function(){b.getPFM().done(function(g){la=g.pfm;LinkUrls.initializeEid(g.eid)});F()})}(G||x.kcrFree)&&ha.resolve();KindleChromeInstaller.initialize()}}},registerEventCallback:function(g,a){var p=[],b;for(b in Kindle.APP_CACHE)p.push(Kindle.APP_CACHE[b]);p.indexOf(g)>=0&&KindleAppCacheEventHandler.addEventListener(g,a)},getSharedModuleSync:function(g){na.indexOf(g)===-1&&KindleDebug.error(g+"is not a shared module");return KindleModuleManager.getModuleSync(g)},getSharedModules:function(){return KindleModuleManager.getModuleList(na)},
getAppInterfaceForReader:function(){function g(a){setTimeout(function(){m(a);d()},0)}return G?{onReaderReady:j,closeReader:function(a){G.onBookClose();g(a)},onStartReadingStatus:function(a){G.onBookOpenStatus(a);(!a||!a.canOpen)&&g()},onRendererLoaded:L,openStore:function(g){G.onOpenStore({origin:Z.READER,asin:g})},pinBookToStart:function(g){G.pinBookToStart(g)},onReaderTapped:function(){G.onReaderTapped()},onUserAction:function(){G.onUserAction()},hideAppBar:function(){G.hideAppBar()},onBookDownloadComplete:function(g){G.onBookDownloadComplete(g)},
searchContent:function(g){G.searchContent(g)},showAnnotations:function(g){G.showAnnotations(g)},isHostControlled:a,isEmbeddedInWebsite:f}:{onReaderReady:j,closeReader:r,onStartReadingStatus:t,onRendererLoaded:L,openStore:function(g){R(Z.READER,g)},openFullKCR:T,register:ia,deregister:ca,pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){},onBookDownloadComplete:function(){},searchContent:function(){},showAnnotations:function(){},isHostControlled:a,
isEmbeddedInWebsite:f}},setReaderInterface:function(g){KindleInterfaces.assertImplements(g,KindleInterfaces.IKindleReader);H=g},getAppInterfaceForLibrary:function(){return{openExternalLink:function(g){W(g,!0)},storeIsTOS:O,openStore:function(g){R(Z.LIBRARY,g)},openBook:k,onLibraryLoaded:s,getQueryParameters:function(){return x},register:ia,deregister:ca}},setLibraryInterface:function(g){KindleInterfaces.assertImplements(g,KindleInterfaces.IKindleLibrary);S=g},cleanupForNextUser:qa,register:ia,deregister:ca,
getQueryParams:function(){return x},gotoURL:W,isHostControlled:a,isEmbeddedInWebsite:f,getEmbeddorHostname:function(){return oa},getPartnerTag:da}}var KindleApp=KindleAppFactory();typeof amznJQ!=="undefined"&&amznJQ.declareAvailable("cascade");
var KindleBanner=function(){function a(){if(k){var a=window.innerHeight||document.body.clientHeight||document.documentElement.clientHeight;a-=$("#"+b.KINDLE_BANNER_CONTAINER_ID).height();a={height:a};$("."+b.KINDLE_APP_CONTAINER).css(a)}}function f(){if(!k){k=!0;$("."+b.KINDLE_BANNER_CONTAINER_ID).css("display","block");var c={top:$("#"+b.KINDLE_BANNER_CONTAINER_ID).height()+"px"};$("."+b.KINDLE_APP_CONTAINER).css(c);a();window.addEventListener("resize",a)}}function d(a){return"https://images-na.ssl-images-amazon.com/images/P/"+
a+".01._SX60_SY80_TTXW_SCLZZZZZZZ_.jpg"}var b={KINDLE_APP_CONTAINER:"KindleAppContainer",KINDLE_BANNER_CONTAINER_ID:"KindleBannerContainer",KINDLE_BANNER_CENTER:"kindleApp_banner_center",KINDLE_BANNER_TEXT:"kindleApp_banner_RWIS_text"},c,k=!1,m={rwis:4,next_available:5},l={rwis:1};return{showRWISBanner:function(o,s){function h(){c.emit("Banner::RWIS::LearnMore")}function u(){c.emit("Banner::RWIS::GetAppLink")}if(!m.rwis||!l.rwis?0:LocalStorageCounter("kcrNotification."+m.rwis).getValue()<l.rwis){c||
(c=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));c.emit("Banner::RWIS::Show");var q=KindleHostDeviceDetector.isiOS(),n=o&&o==="kcr_rwis_kshare"?!0:!1,n={learnMoreLink:LinkUrls.getKCPLandingPageLink(o),bookCoverURL:d(s),isiPad:q,isKp:n},n=$(Handlebars.templates.KindleRWISBanner(n)),v=ResourceBundle.getLanguage();if(q)switch(n.find("#kindleApp_banner_get_app_button").click(u),v){case "de":case "fr":n.find("#"+b.KINDLE_BANNER_CENTER).css("width","540px");n.find("#"+b.KINDLE_BANNER_TEXT).css({"line-height":"20px",
"padding-top":"0"});break;case "ja":case "it":n.find("#"+b.KINDLE_BANNER_TEXT).css("padding-top","0");n.find("#"+b.KINDLE_BANNER_CENTER).css("width","465px");break;case "pt":n.find("#"+b.KINDLE_BANNER_TEXT).css("padding-top","0");n.find("#"+b.KINDLE_BANNER_CENTER).css("width","505px");break;case "es":n.find("#"+b.KINDLE_BANNER_TEXT).css("padding-top","0"),n.find("#"+b.KINDLE_BANNER_CENTER).css("width","525px")}else q={showAppleLogo:!0,showWindowsLogo:!Kindle.URL.isJPDomain(),showAmazonLogo:!0,showAndroidLogo:!0},
q=new KindleTextMeWidget(q,"KindleRWISBanner"),n.find("#kindleApp_banner_text_me_widget_wrapper").append(q),n.find("#kindleApp_banner_learn_more").click(h),v==="fr"&&n.find("#"+b.KINDLE_BANNER_TEXT).css("line-height","20px");n.find("#kindleApp_banner_close_button").click(function(){k&&(window.removeEventListener("resize",a),$("."+b.KINDLE_BANNER_CONTAINER_ID).css("display","none"),$("."+b.KINDLE_APP_CONTAINER).css({top:"0px",height:"100%"}),k=!1);m.rwis&&l.rwis&&LocalStorageCounter("kcrNotification."+
m.rwis).increment();c.emit("Banner::RWIS::Close")});$("#KindleBannerContainer").append(n);f()}},changeBookCover:function(a){k&&(a=d(a),$("#kindleApp_banner_book_cover").attr("src",a))}}}(),KindleBuildInfo=function(){function a(a,b,c){var k=$.Deferred();$.getJSON(f,Math.floor(Math.random()*1E9),function(m){m=m[a];c(m)?k.resolve(m):k.reject(b)}).error(function(){k.reject(b)});return k.promise()}var f="./offline/build_info.uncached.js";return{getCurrentTotalAppcacheFileCount:function(){return a("filecount",
-1,function(a){return typeof a==="number"&&a>1})}}}(),KindleMetricsManager=function(){function a(){function a(){Date.now()-j>b&&(P=Date.now());j=Date.now();setTimeout(a,e)}if(!M){M=!0;var b=2E4,e=5E3,j;P=0;Date.now();j=Date.now();setTimeout(a,e)}}function f(a){if(a.timerStart>=P)return!0;a=Date.now()-a.timerStart;B("Metrics::Suspended",{time:a});return!1}function d(){if(E.length>0){var a=E;E=[];h().insertList(a).fail(function(){Array.prototype.push.apply(a,E);E=a})}}function b(){e&&A<=Date.now()+
N||(clearTimeout(e),e=setTimeout(function(){e=null;b();s()},N),A=Date.now()+N)}function c(a){if($.isArray(a))return a;var b;if(a){b=[];for(var e in a)b.push(a[e])}return b}function k(a){var b=a.timers;if(b)for(var e in b);a.timers=c(a.timers);a.counters=c(a.counters)}function m(a){for(var b=new jQuery.Deferred,e=0;e<a.length;e++)k(a[e]);a.length>0&&h()?h().insertList(a).then(function(){b.resolve(a)},function(){o(a).then(function(){b.resolve(a)},function(){Array.prototype.push.apply(E,a);b.reject(a)})}):
(Array.prototype.push.apply(E,a),b.resolve(a));return b.promise()}function l(a,b,e){var j=y[a],a=j.counters;if(!a)a=j.counters={};j=a[b];if(!j&&(j=a[b]={},j.name=b,j.count=0,e))typeof e==="string"&&(e=[e]),j.breakDown=e;return j}function o(a){var b=new jQuery.Deferred,e=/exception/i;D()?z(t.devicePlatform,t.clientName,t.version,t.marketplace,t.breakdownDeclarations,a).then(function(j){j.Output.metricProcessCount&&j.Output.metricProcessCount>0||j.Output.__type&&j.Output.__type.match(e)?b.resolve(a):
b.reject(a)},function(){b.reject(a)}):b.reject(a);return b.promise()}function s(){var a,b=new jQuery.Deferred;if(D()){if(!h())return b.reject(),b.promise();h().batchTransaction([{operation:Kindle.DB.GET_RECORD_OPERATION,tableName:F,params:[]},{operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:F,params:[]}]).done(function(e){if(e[0]&&e[0].length>0){a=e[0];for(e=0;e<a.length;e++){var j=a[e];if(j.breakDown)j.breakdown=j.breakDown,delete j.breakDown}o(a).done(b.resolve).fail(function(){h()&&h().insertList(a);
b.reject()})}}).fail(function(){b.reject()})}else b.reject();return b.promise()}function h(){try{if(I)return I.getAppDb().getTable(F)}catch(a){}return null}function u(a){function b(a,g){var p={};p.name=g.name;p.count=g.value;var e=q(g.breakdown);if(e.length>0)p.breakDown=e;if(!a.counters)a.counters=[];a.counters.push(p)}if(!(typeof a==="object"&&typeof a.name==="string"&&typeof a.params==="undefined"||typeof a.params==="object"))return null;var e={},r=a.name,a=$.extend({},a.params);e.method=r;e.time=
0;if(a){if(a.time>=0&&j(a.time))e.time=a.time;if(a.submetrics){if(!$.isArray(a.submetrics))a.submetrics=[a.submetrics];for(r=0;r<a.submetrics.length;r++)b(e,a.submetrics[r])}r=q(a.breakdown);if(r.length>0)e.breakDown=r}return e}function q(a){var b=[];if(a===void 0)return b;$.isArray(a)||(a=[a]);for(var e=0;e<a.length;e++)typeof a[e]==="string"&&(r.indexOf(a[e]),b.push(a[e]));return b}function n(a){a||(a={});if(!a.startTime)a.startTime=Date.now();j(a.startTime);this.params=a}function v(a,b){return a=
$.map(a,function(a){a.time=b;return a})}function w(a){if(typeof a[0]==="string"){var b={};b.name=a[0];if(a[1])b.params=a[1];a=[b]}else a=$.isArray(a[0])?a[0]:[];return $.map(a,u)}function C(){}function B(){var a=w(arguments);return m(a).fail(C)}var F="metrics",I=null,E=[],K=0,y={},z,D=function(){return navigator.onLine},j=isNumber,t={breakdownDeclarations:{}},r=["Browser","Version","Partner","ProcessorClass","ViewState","SystemLanguage","Online","CloudItemsCount","LocalItemsCount","HostVersion","PFM",
"CrashLocation"],L=Object.freeze({Short:3E4,Default:3E5,Min:1E4,Max:6E5}),e=null,A=0,N=L.Default,P,M=!1;n.prototype.elapsed=function(){var a=0;j(this._elapsed)?a=this._elapsed:j(this.params.startTime)&&f({timerStart:this.params.startTime})&&(a=Date.now()-this.params.startTime);return a};n.prototype.stop=function(){this._elapsed=Date.now()-this.params.startTime;return this};n.prototype.emit=function(){var a=this.elapsed(),b=w(arguments),b=v(b,a);return m(b).fail(C)};n.prototype.emitNow=function(){var a=
this.elapsed(),b=w(arguments),b=v(b,a);return o(b).fail(C)};return{modifyMetricsMethod:function(a,b){if(y[a])y[a].method=b},startMetrics:function(a,b){var e={};e.method=a;e.timerStart=Date.now();if(b&&b.breakdown)e.breakDown=q(b.breakdown);K++;y[K]=e;return K},endMetrics:function(a,b){var e,j=y[a];if(j&&j.timerStart){if(f(j))j.time=Date.now()-j.timerStart;delete j.timerStart;var r=[j];b&&(typeof b==="string"&&(b=[b]),$.each(b,function(a,b){var e=$.extend({},j);e.method+=b;r.push(e)}));e=m(r);delete y[a]}else e=
(new jQuery.Deferred).reject().promise();return e},cancelMetrics:function(a){delete y[a]},startSubTimer:function(a,b,e){var j=y[a],a=j.timers;if(!a)a=j.timers={};j=a[b];if(!j&&(j=a[b]={},j.name=b,j.count=0,j.time=0,e=q(e),e.length>0))j.breakDown=e;if(!j.timerStart)j.timerStart=Date.now()},endSubTimer:function(a,b){var e=y[a].timers[b];e.timerStart!==void 0&&(f(e)&&(e.count+=1,e.time+=Date.now()-e.timerStart),delete e.timerStart)},renameSubTimer:function(a,b,e){var a=y[a],j=a.timers[b];if(j.time>=
0)a.timers[e]=j,a.timers[e].name=e,delete a.timers[b]},getSubTimer:function(a,b){return y[a].timers[b]},setSubCounter:function(a,b,e,r){a=l(a,b,r);j(e)||(e=1);a.count=e},increaseSubCounter:function(a,b,e,r){a=l(a,b,r);j(e)||(e=1);a.count+=e},initialize:function(e){z=e.uploadCallback;t=$.extend(t,e.platformContext);I=e.dbClient;D=e.isOnline||D;j=e.isNumber;e.persistMetrics&&(d(),b());a()},uploadMetrics:s,setMetricsUploadInterval:function(a){var e=N;L.Min<a&&a<L.Max||(a=N);a!==N&&(N=a,b());return e},
UploadInterval:L,setBreakdown:function(a,b){$.isArray(b)&&(b=b.join(":"));typeof b==="string"&&r.indexOf(a)>-1&&(t.breakdownDeclarations[a]=b)},clearBreakdowns:function(){t.breakdownDeclarations={}},replaceBreakdowns:function(a){t.breakdownDeclarations=a},createTimer:function(){return new n},emitNow:function(){var a=w(arguments);return o(a).fail(C)},emit:B}}(),KindleNetwork=function(){function a(){return o=navigator.onLine}function f(){a()===!1?d(!1):$.ajax("/service/web/reader/ping")}function d(a){m&&
(window.clearTimeout(m),m=0);l=Date.now();a!==k&&(k=a,c.callEventListeners(a?"online":"offline"));b()}function b(){c.hasEventListener(k?"offline":"online")?m||(m=window.setTimeout(f,k?9E5:18E4)):m&&(window.clearTimeout(m),m=0)}var c=new ListenerManager,k=!0,m,l=0,o;return{pingNA:function(){var a=new $.Deferred;$.ajax("https://read.amazon.com").then(function(b,c,d){a.resolve(d&&d.status!==0)},function(){a.resolve(!1)});return a.promise()},initialize:function(){$(document).ajaxComplete(function(a,b,
c){c.qaMetricsIngester||d(!!b.status)});document.body.addEventListener("offline",f);document.body.addEventListener("online",f);d(a())},addEventListener:function(a,d){c.addEventListener(a,d);b()},removeEventListener:function(a,d){c.removeEventListener(a,d);b()},isOnline:function(b){o!==a()&&d(o);b=Number(b);return Date.now()-l<(b>=0?b:Infinity)?k:o===!1?!1:null}}}();
Kindle.RefTag=function(){return{Values:{StorePromoMangaJP:"kcr_store_promo_manga_jp",StoreLibButton:"kcr_store_libbutton",StoreSample:"kcr_store_sample",StoreSampleClose:"kcr_store_sample_close",StoreEmptyLibIpad:"kcr_store_emptylib_ipad",StoreLibButtonIpad:"kcr_store_libbutton_ipad"},isRWISRefTag:function(a){return a&&a.indexOf("kcr_rwis_")===0}}}();
var KindleRegistrationHandler=function(){function a(){var a=f(Kindle.URL.getBaseURL()),c=d.apUrl;c+="?openid.assoc_handle="+d.assocHandle;c+="&openid.return_to="+encodeURIComponent(a);c+="&openid.mode=logout";c+="&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0";(a=Kindle.URL.getSiteState())&&(c+="&"+a);KindleApp.gotoURL(c)}function f(a){var c=d.apUrl;c+="?openid.assoc_handle="+d.assocHandle;c+="&openid.return_to="+encodeURIComponent(a);c+="&openid.mode=checkid_setup";c+="&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0";
c+="&openid.identity=";c+="http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select";c+="&openid.claimed_id=";c+="http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select";c+="&pageId=amzn_kcr";(a=Kindle.URL.getSiteState())&&(c+="&"+a);return c}var d=function(){function a(b){b=b.toLowerCase();return{apUrl:"https://"+b+"-pre-prod.amazon.com/ap/signin",assocHandle:"amzn_kweb_"+b}}var c=Kindle.URL.getAmazonDomain();if(Kindle.URL.isPreProd()){var d=Kindle.URL.getPreProdCountryCode();if(d)return a(d)}return function(){var a=
Kindle.DomainToCountryMap[c];return{apUrl:"https://www."+c+"/ap/signin",assocHandle:a==="us"?"amzn_kweb":"amzn_kweb_"+a}}()}();return{register:function(){KindleApp.gotoURL(f(Kindle.URL.getBaseURL()))},deregister:function(b,c){function d(){var a=new jQuery.Deferred;KindleModuleManager.getModule(KindleModuleManager.JOURNAL_MANAGER).then(function(b){b.uploadJournal().then(a.resolve,a.resolve)});return a.promise()}function m(){var a=new jQuery.Deferred;v.getAppDb().getPinnedSessionIds().done(function(b){KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).deregisterSessions(b).then(a.resolve,
a.reject)});return a.promise()}function l(){function a(){f.uploadMetrics().then(s,s)}q.then(a,a)}function o(){h.reject()}function s(){c?KindleApp.cleanupForNextUser().then(function(){KindleDebug.log("db & localStorage cleared.");KindleApp.isHostControlled()||a();h.resolve()},function(){KindleDebug.log("Failed to clear db/localStorage");KindleApp.isHostControlled()||a();h.resolve()},function(a){h.notify(a)}):(KindleLocalStorage.removeItem(Kindle.App.LIBRARY_FAIL_FLAG),v.getAppDb().clearDeviceToken().then(a,
a),h.resolve())}var h=new jQuery.Deferred,f=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),q,n=f.createTimer();q=c?n.emit([{name:"Library::SignOut"},{name:"Library::SignOut:Intentional"}]):n.emit([{name:"Library::SignOut"},{name:"Library::SignOut:Unintentional"}]);var v=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT);b?s():$.when(d(),m()).then(l,o);return h.promise()}}}(),KindleStreamingReaderClient=function(){function a(a){var b,a=a||{};b=(a.srsHostName||
"")+("/"+(a.srsBasePath||"service")+"/")+"web/";I=b+"content/";a.useSignedServiceRequests&&(b+="device/");F=b+"reader/";E=b+"register/";K=F+"setOfflineStatus/";y=F+"deregisterSessions/";z=F}function f(){D=!0}function d(a){var b={prevState:N,newState:a};if(a===Kindle.Service.AuthOK&&(b.eid=L,e))b.deviceName=e;N=a;A.onServiceAuthState(b)}function b(a,b,e){function j(){d(Kindle.Service.AuthError);r.reject(a,b,e)}if(a.status===B){var r=$.Deferred();t=null;M.clearDeviceToken().then(j,j);return r.promise()}else return $.Deferred().reject(a,
b,e)}function c(a,e){return $.ajax({url:a,dataType:"json",beforeSend:function(a){a.setRequestHeader("x-amzn-sessionid",e);return!0}}).pipe(null,b)}function k(){var a=$.cookie("session-id"),b=function(){var a=E+"getDeviceToken",g=KindleHostDeviceDetector.getDeviceType();a+="?serialNumber="+(Q||g)+"&deviceType="+g;return encodeURI(a)}(),e=P.createTimer();return c(b,a).pipe(function(a,g,b){g=jQuery.Deferred();a.deviceSessionToken?g.resolve(a):(g.reject(b,"failed"),e.emit("Service::GetDeviceTokenCallBrokenResult"));
e.emit("Service::GetDeviceTokenCall");return g.promise()}).fail(function(){e.emitNow("Service::GetDeviceTokenCallFail")})}function m(a,b){return{url:a,type:"POST",dataType:"json",processData:!1,contentType:"application/json",data:JSON.stringify(b)}}function l(a){function e(){KindleDebug.error("Failed to sign SRS request.");return $.Deferred().reject()}function j(a){var g;g=/\/web.*$/.exec(a.url);return!g?e():A.getRequestSigningHeaders({path:g[0],verb:a.type||"GET",data:a.data||""}).pipe(function(g){a.beforeSend=
function(a){$.each(g,function(g,b){a.setRequestHeader(g,b)});return!0};return $.Deferred().resolve(a)},e)}function r(a){return t?(a.beforeSend=function(a){a.setRequestHeader("X-ADP-Session-Token",t);return!0},$.Deferred().resolve(a)):(KindleDebug.error("Device Token must be loaded in order to make an authenticated request. Cancelling request."),d(Kindle.Service.AuthError),$.Deferred().reject())}n();return(J?j(a):r(a)).pipe($.ajax).pipe(null,b)}function o(a){a.beforeSend=function(a){a.setRequestHeader("Amzn-Device-Type",
KindleHostDeviceDetector.getDeviceType());return!0};return $.ajax(a)}function s(a){function b(){l(r).done(j.resolve).fail(function(a){KindleHostDeviceDetector.isiOSAppMode()&&a.status===0&&d.emit("KindleApp::iOSAppModeStatusCodeIsZero")}).fail(function(a,g,e){a.status!==B&&(g!=="timeout"&&t-- >0?(setTimeout(b,c),c*=2):j.reject(a,g,e))})}var e=a.url,j=$.Deferred(),r={url:e,dataType:"json"},t=1,c=50;b();var d=P.createTimer();j.done(function(){d.emit(a.metricId)});j.fail(function(){d.emitNow(a.metricId+
"Fail")});return j.promise()}function h(a){function b(){o(r).done(j.resolve).fail(function(a,g,e){a.status!==B&&g!=="timeout"&&t-- >0?(setTimeout(b,c),c*=2):j.reject(a,g,e)})}var e=a.url,j=$.Deferred(),r={url:e,dataType:"json"},t=1,c=50;b();var d=P.createTimer();j.done(function(){d.emit(a.metricId)});j.fail(function(){d.emitNow(a.metricId+"Fail")});return j.promise()}function u(){function a(g,b,e){function j(){(!g||g.status!==B)&&d(Kindle.Service.AuthError);h.reject(g,b,e)}t=null;M.clearDeviceToken().then(j,
j)}function b(){N!==Kindle.Service.AuthOK&&d(Kindle.Service.AuthOK);h.resolve(t)}function j(c){if(r&&r!==c.clientHashId)d(Kindle.Service.AuthUserMismatch);else{t=c.deviceSessionToken;r=c.clientHashId;L=c.eid;if(c.deviceName)e=c.deviceName;jQuery.when(M.setDeviceToken(c.deviceSessionToken),M.setUserHashId(c.clientHashId),M.setEID(c.eid)).then(b,a)}}function c(){k().then(j,a)}function A(a){r=a[Kindle.Service.UserHashIdKey];L=a[Kindle.Service.EidKey];a[Kindle.Service.DeviceTokenKey]?(t=a[Kindle.Service.DeviceTokenKey],
b()):c()}var h=$.Deferred();t?h.resolve(t):M.getValuesForKeys([Kindle.Service.DeviceTokenKey,Kindle.Service.UserHashIdKey,Kindle.Service.EidKey]).then(A,c);return h.promise()}function q(){var a=$.Deferred();M.getValuesForKeys([Kindle.Service.DeviceTokenKey,Kindle.Service.UserHashIdKey,Kindle.Service.EidKey]).then(function(b){r=b[Kindle.Service.UserHashIdKey];L=b[Kindle.Service.EidKey];b[Kindle.Service.DeviceTokenKey]?(t=b[Kindle.Service.DeviceTokenKey],a.resolve(!0)):a.resolve(!1)},function(){a.resolve(!1)});
return a.promise()}function n(){function a(){d(Kindle.Service.AuthTokenMismatch);b.reject()}var b=$.Deferred();if(!t)return b.resolve();var e=P.createTimer();M.getDeviceToken().done(function(j){j!==t?e.emit("Service::CheckTokenConsistencyMismatch",{breakdown:["Browser"]}).always(a):b.resolve()}).fail(function(){D||e.emit("Service::CheckTokenConsistencyFail",{breakdown:["Browser"]}).always(a)});return b.promise()}function v(a){return a&&(a==="only"||N!==Kindle.Service.AuthOK)}function w(a,b){var e=
F+a+"?asin="+b.asin+"&kindleSessionId="+b.kindleSessionId;return b.position&&b.position>0?(e+="&lastPageRead="+b.position+"&localTimeOffset="+b.localTimeOffset+"&countryCode="+b.countryCode,e+="&positionType="+b.positionType,e=encodeURI(e)+(!b.refEmId?"":"&guid="+encodeURIComponent(b.refEmId))):encodeURI(e)}function C(a,b,e,j,r,c){function t(a,g,b,e,p,r){return{Operation:r?"uploadMetricsExternal":"uploadMetrics",Input:{devicePlatform:a,clientName:g,version:b,marketplace:j,metricBreakdown:e,metrics:p}}}
var d;return function(){function j(a,g,b){var e=$.Deferred();return b.responseText.indexOf("UploadMetricsResponse")===-1?e.reject():e.resolve(a,g,b)}var A=Kindle.Service.AuthOK===N&&(J||$.cookie("at-main")),h=F+"uploadMetrics";return A?(d=t(a,b,e,r,c,!1),l(m(h,d)).pipe(j)):$.Deferred().reject()}().pipe(null,function(){var j=I+"uploadMetrics";d=t(a,b,e,r,c,!0);return o(m(j,d))}).done(function(){var a;if(a=O||KindleLocalStorage.getItem("QAMetricsURL"))a={url:a,type:"POST",dataType:"json",processData:!1,
headers:{Source:window.location.href},contentType:"application/json",data:JSON.stringify(d),qaMetricsIngester:!0},$.ajax(a).fail(function(a){a.status&&KindleDebug.warn("Failed to echo metrics to the QA ingester service; statusCode="+a.statusCode)})})}var B=403,F,I,E,K,y,z,D=!1,j,t,r,L,e,A,N,P,M,Q,J,O,R;a();$.ajaxSetup({headers:{"Cache-Control":"no-cache",Pragma:"no-cache"},timeout:6E4});var T={getAuthenticationState:function(){return N},authenticate:function(){if(N===Kindle.Service.AuthOK)return $.Deferred().resolve();
else if(J)return $.Deferred().reject();return u()},checkTokenConsistency:n,deregisterSessions:function(a){return s({metricId:"Service::DeregisterSessionsCall",url:function(a){a=y+"?sessions="+a.join();return encodeURI(a)}(a)})},doneReading:function(a){return s({metricId:"Service::DoneReadingCall",url:w("doneReading",a)})},getAnnotations:function(a,b){var e=F+"getAnnotations?asin="+encodeURIComponent(a)+(!b?"":"&guid="+encodeURIComponent(b));return s({metricId:"Service::GetAnnotationsCall",url:e})},
getEID:function(){function a(){return $.Deferred().resolve(L)}function b(){var e=P.createTimer();return k().fail(function(){e.emitNow("Service::GetEIDTokenCallFail")}).pipe(function(b){L=b.eid;e.emit("Service::GetEIDTokenCallSuccess");return M.setEID(b.eid).pipe(a,a)},null)}return L?a():M.getEID().pipe(null,b)},getFileUrl:function(a){var b=v(a.kcrFree),e={metricId:"Service::GetFileUrlCall",url:function(){var e=b?I:F;e+="getFileUrl?asin="+a.asin+"&contentVersion="+a.contentVersion+"&formatVersion="+
a.formatVersion;KindleHostDeviceDetector.hasCanvasSizeLimitProblem()||(e+="&clientVersion="+j);e+=R?"&usePdxBucket="+R:"";e+=a.kindleSessionId?"&kindleSessionId="+a.kindleSessionId:"";e+=a.isSample?"&isSample="+a.isSample:"";e+=a.skeletonIds?"&skeletonIds="+a.skeletonIds.join(","):"";e+=a.fragmentIds?"&fragmentIds="+a.fragmentIds.join(","):"";e+=a.glyphIds?"&glyphIds="+a.glyphIds.join(","):"";e+=a.resourceIds?"&resourceIds="+a.resourceIds.join(","):"";e+=a.locationMapIds?"&locationMapIds="+a.locationMapIds.join(","):
"";return encodeURI(e)}()};return(b?h:s)(e)},getLPR:function(a,b){var e=F+"getLPR?asin="+encodeURIComponent(a)+(!b?"":"&guid="+encodeURIComponent(b));return s({metricId:"Service::GetLPRCall",url:e})},getOemAssociateId:function(a){var a={Operation:"getAssociateId",Input:{deviceType:a.deviceType,deviceParameters:{eid:a.eid,oemPartnerName:a.oemPartnerName,oemDealGuid:a.oemDealGuid}}},b=F+"getAssociateId",e=P.createTimer();return l(m(b,a)).then(function(a){e.emit("Service::OemAssociateIdSuccess");(!a||
!a.Output||!a.Output.associateId)&&e.emit("Service::OemAssociateIdEmpty")},function(){e.emit("Service::OemAssociateIdFailure")})},getOwnedContent:function(a,b){return s({metricId:"Service::GetOwnedContentCall",url:function(){var e="";a&&(e="?lastSyncTime="+encodeURIComponent(a));b&&(e?e+="&":e="?",e+="reason="+encodeURIComponent(b));return F+"getOwnedContent"+e}()})},getPFM:function(){return s({metricId:"Service::GetPFMCall",url:F+"getPFM"})},getTodoItems:function(a){var b=a.reason,e=a.versionNumber,
a=z+"getTodoListItems?maxNumItems="+(a.maxNumItems||a.count);b&&(a+="&reason="+b);e&&(a+="&softwareRev="+e);a=encodeURI(a);return s({metricId:"Service::GetTodoItemCall",url:a})},getSearchIndexInfo:function(a){var b=v(a.kcrFree),e=b?I:F;e+="getSearchIndex?asin="+encodeURIComponent(a.asin)+"&formatVersion="+encodeURIComponent(a.formatVersion)+"&contentVersion="+encodeURIComponent(a.contentVersion);return(b?h:s)({url:e,metricId:"Service::GetSearchIndex"})},getWordDefinition:function(a){var b=Kindle.Service.AuthOK===
N,a={metricId:"Service::GetWordDefinitionCall",url:encodeURI((b?F:I)+"getWordDefinition?word="+a)};return(b?s:h)(a)},removeTodoItems:function(a){if(a.length!==1)return $.Deferred().reject("Must be one item").promise();var a=a[0],b=z+"removeTodoListItem";b+="?type="+a.type+"&action="+a.action+"&key="+a.key+"&completeStatus="+(a.completeStatus||a.complete_status)+"&failureCode="+(a.failureCode||a.failure_code||"");b=encodeURI(b);return s({metricId:"Service::RemoveTodoItemsCall",url:b})},resetLPR:function(a){return s({metricId:"Service::ResetLPRCall",
url:w("resetLPR",a)})},removeOwnership:function(a,b){return s({metricId:"Service::RemoveOwnershipCall",url:F+"removeOwnership?asin="+a+"&contentType="+b})},setOfflineStatus:function(a){return s({metricId:"Service::SetOfflineStatusCall",url:encodeURI(K+"?asin="+a.asin+"&kindleSessionId="+a.kindleSessionId+"&offline="+(a.isOffline?"true":"false"))})},setServiceHost:function(g){a({useSignedServiceRequests:J,srsHostName:g})},startReading:function(a){var b=v(a.kcrFree),e={metricId:"Service::StartReadingServiceCall",
url:function(){var e=b?I:F;e+="startReading?asin="+a.asin;e+=a.kindleSessionId?"&kindleSessionId="+a.kindleSessionId:"";e+=a.contentVersion?"&contentVersion="+a.contentVersion:"";e+=a.formatVersion?"&formatVersion="+a.formatVersion:"";e+=a.isSample!==void 0?"&isSample="+(a.isSample?"true":"false"):"";j&&(e+="&clientVersion="+j);return encodeURI(e)}()};return(b?h:s)(e)},stillReading:function(a){return s({metricId:"Service::StillReadingCall",url:w("stillReading",a)})},updateAnnotations:function(a,b){var e=
F+"updateAnnotations",j={Operation:"updateAnnotations",Input:{annotations:a,localTimeOffset:b}},r=P.createTimer();return l(m(e,j)).then(function(){r.emit("Service::UpdateAnnotationsCall")},function(){r.emitNow("Service::UpdateAnnotationsCallFail")})},uploadMetrics:C,uploadSnapshot:function(a){a=z+"uploadSnapshot?snapshot="+encodeURIComponent(a.response);return s({metricId:"Service::UploadSnapshotCall",url:a})},whenOnline:function(){var a=jQuery.Deferred();if(KindleNetwork.isOnline())a.resolve();else{var b=
function(){KindleNetwork.removeEventListener("online",b);a.resolve()};KindleNetwork.addEventListener("online",b)}return a.promise()}};return{initialize:function(){KindleModuleManager.define(Kindle.MODULE.SERVICE_CLIENT,[Kindle.MODULE.SERVICE_INITIALIZATION_ARGS,KindleModuleManager.METRICS_MANAGER,Kindle.MODULE.DB_CLIENT],function(g,b,e){var r=jQuery.Deferred();P=b;M=e.getAppDb();var c,t;A=g.hostApp;if(g.loginParams)Q=g.loginParams.dsn,J=!!g.loginParams.useSignedServiceRequests,O=g.loginParams.qaMetricsUrl,
c=g.loginParams.hostName,t=g.loginParams.srsBasePath,R=g.loginParams.usePdxBucket;j=KindleApp.isHostControlled()?KindleVersion.parseVersionString(g.hostVersion):KindleVersion.getVersionNumber();KindleNetwork.initialize();window.addEventListener("beforeunload",f,!1);J?M.getUserHashId().always(function(b){b&&g.loginParams.clientHashId&&b!==g.loginParams.clientHashId?d(Kindle.Service.AuthUserMismatch):d(Kindle.Service.AuthOK);a({useSignedServiceRequests:!0,srsHostName:c,srsBasePath:t});r.resolve(T)}):
(t&&a({srsBasePath:t}),q().then(function(a){d(a?Kindle.Service.AuthOK:Kindle.Service.NotAuth);r.resolve(T)},r.reject));return r});KindleModuleManager.define(Kindle.MODULE.METRICS_UPLOADER,[],function(){return{uploadMetrics:C}})}}}(),KindleTOS=function(){function a(){var a="https://images-na.ssl-images-amazon.com/images/G/01/kindle/kindlefortheweb/store/"+K+"/BrowserHost-min.js",b=$.Deferred();if(f())return b.resolve().promise();$.getScript(a,function(){f()?b.resolve():b.reject()});return b.promise()}
function f(){return typeof BrowserHostAPI!=="undefined"}function d(){var a=new jQuery.Deferred,b={w:$(window).width(),h:$(window).height(),dpi:null,osv:null,deviceType:KindleHostDeviceDetector.getDeviceType(),bhv:K};KindleModuleManager.getModule([KindleModuleManager.SERVICE_CLIENT]).then(function(e){e.getEID().then(function(e){b.eid=e;a.resolve("?"+$.param(b))},function(){KindleDebug.error("Couldn't fetch EID.");a.reject("?"+$.param(b))})},function(){KindleDebug.error("SRS not loaded");a.reject("?"+
$.param(b))});return a.promise()}function b(a){function b(e){var j=B?"&asin="+encodeURIComponent(B):"",e=E+e+j+("&ref_="+(a||(B?Kindle.RefTag.Values.StoreSample:I?Kindle.RefTag.Values.StoreEmptyLibIpad:Kindle.RefTag.Values.StoreLibButtonIpad))),j=KindleApp.getPartnerTag();e+=j?"&tag="+j:"";u&&$("#"+q.KINDLE_STORE_CONTAINER_ID).addClass("hidden").empty();j=new Date;u=$(document.createElement("iframe")).attr("id",q.KINDLE_STORE_ID+j.getTime()).attr("src",e).attr("seamless","seamless").addClass(n);$("#"+
q.KINDLE_STORE_CONTAINER_ID).append(u)}d().then(b,b)}function c(){$("#"+q.KINDLE_STORE_CONTAINER_ID).addClass("hidden").empty();D=u=null;j=!0;z&&z()}function k(){var b=$.Deferred();a().then(function(){var a={hostVersion:v,storeStartTime:F,deviceType:KindleHostDeviceDetector.getDeviceType()};BrowserHost=new K4WBrowserHost(a,{pageReady:m,closeStore:l,openBook:o,bookStatus:s,openInExternalBrowser:h});b.resolve()},b.reject);return b.promise()}function m(){clearTimeout(w);$("#"+q.KINDLE_STORE_CONTAINER_ID).removeClass("hidden");
C.resolve(!1)}function l(){c()}function o(a){if(j){j=!1;var b=a.type,a=a.asin;if(y)switch(b){case t.EBOOK:y({asin:a,isSample:!1});c();break;case t.SAMPLE:y({asin:a,isSample:!0}),D=a,$("#"+q.KINDLE_STORE_CONTAINER_ID).hide(),z&&z()}}}function s(a){return{id:a,status:1,percentDownloaded:1}}function h(a){clearTimeout(w);C.resolve(!0);var b=document.createElement("a");b.href=a;b.target="_blank";a=document.createEvent("MouseEvents");a.initEvent("click",!0,!0);b.dispatchEvent(a)}var u,q={KINDLE_STORE_ID:"store",
KINDLE_STORE_CONTAINER_ID:"KindleStoreContainer"},n="KindleIFrame",v=3,w,C,B,F,I,E="https://www.amazon.com/gp/kindle/kcp/tos.html",K="029",y,z,D,j=!0,t={EBOOK:"EBOK",SAMPLE:"EBSP"};return{open:function(a){C=$.Deferred();B=a.asin;F=a.storeStartTime;I=a.isSourceEmptyLibBtn;if(B&&B===D&&u)return $("#"+q.KINDLE_STORE_CONTAINER_ID).show(),C.resolve(!1),C.promise();k().then(function(){w=setTimeout(function(){C.reject();c()},3E4);b(a.refTag)},C.reject);return C.promise()},setOpenBookCallback:function(a){y=
a},setStoreClosedCallback:function(a){z=a},setOpenBookReady:function(){j=!0},setStoreURL:function(a){E=a},proxyTouchEvent:function(a){if(f()){var b=JSON.parse(JSON.stringify(a));b.type=a.type;b.bubbles=a.bubbles;BrowserHost.proxyTouchEvent(b)}}}}(),KindleUpgradeDeviceDetector=function(){function a(a,d,b){a=KindleVersion.parseVersionString(a);return KindleVersion.parseVersionString(d)<=a&&a<=KindleVersion.parseVersionString(b)}return{isMetroUpdateRequiredBecauseVersionNonSupported:function(f){if(!KindleHostDeviceDetector.isMetro())return!1;
var d=!!KindleHostDeviceDetector.isOnline();return f&&d?a(f,"0.0.0.0","1.1.3.1"):!1},isMetroUpdateRequiredBecauseI18NSupported:function(f,d){if(!KindleHostDeviceDetector.isMetro())return!1;var b=!!KindleHostDeviceDetector.isOnline();return["de","es","it","fr","pt"].indexOf((d||KindleHostDeviceDetector.getBrowserLanguage()).substr(0,2))>-1&&f&&b?a(f,"1.0.2.0","1.0.2.99"):!1},isMetroUpdateRequiredBecauseCountryNotSupported:function(f,d,b){var c=jQuery.Deferred(),k=!!KindleHostDeviceDetector.isOnline(),
d=(d||KindleHostDeviceDetector.getBrowserLanguage()).substr(0,2);if(!KindleHostDeviceDetector.isMetro()||!k||!a(f,"1.0.2.0","1.0.2.99"))return c.resolve(!1).promise();f="/kcrservice/checkBLCountry?lang="+d;b&&(f+="&ip="+b);$.ajax({url:f,dataType:"json"}).then(function(a){c.resolve(a?a.value:!1)},function(){c.resolve(!1)});return c.promise()}}}(),ResourceBundle=function(a,f){function d(a){return!a||!h[a.toUpperCase()]?"":a.toUpperCase()}function b(a){return!a?"":s[a]?a:a.length===2&&C[a]?C[a]:(a=C[a.substr(0,
2).toLowerCase()])?a:""}function c(){KindleAssert(n,"Language and culture must be set before calling getLanguage");return n.substr(0,2).toLowerCase()}function k(){KindleAssert(v,"Language and culture must be set before calling getFormatRegion");return v}function m(a,b){function c(a,j){var d=b[j];delete b[j];return d}for(var d=/\$\{([A-Za-z0-9_]+)\}/g,b=$.extend({},b),j;d.exec(a)&&j!==a;)j=a,a=a.replace(d,c);return a}function l(a){return a&&a.length>=5?a.substr(3,2).toUpperCase():""}function o(){return navigator&&
(navigator.language||navigator.userLanguage)?navigator.language||navigator.userLanguage:""}var s=a,h=f,u=!1,q,n,v,w=-(new Date).getTimezoneOffset(),C={de:"de-DE",en:"en-US",es:"es-ES",fr:"fr-FR",it:"it-IT",pt:"pt-BR",ja:"ja-JP",zh:"zh-CN"},B={"amazon.com":"en-US","amazon.com.au":"en-AU","amazon.co.uk":"en-GB","amazon.in":"en-IN","amazon.ca":"en-CA","amazon.de":"de-DE","amazon.fr":"fr-FR","amazon.it":"it-IT","amazon.es":"es-ES","amazon.com.mx":"es-MX","amazon.com.br":"pt-BR","amazon.co.jp":"ja-JP",
"amazon.cn":"zh-CN"},F=function(a,b){if(u)return a;if(s[b])return s[b][a]},I={en:["the ","a ","an "],de:["die ","der ","das ","des ","dem ","den ","ein ","eine ","einer ","einem ","einen "],es:["el ","la ","los ","las ","un ","una ","unos ","unas "],pt:["o ","a ","os ","as ","um ","uma ","uns ","umas "],fr:["le ","la ","l'","les ","un ","une ","des "],it:["il ","lo ","la ","l'","i ","gli ","le ","un ","uno ","una ","un'"]},E={da:["og","i","jeg","det","at","en","den","til","er","som","p\u00e5","de",
"med","han","af","for"],de:["der","die","das","des","dem","den","ein","eine","einer","einem","einen","dies","diese","diesem","diesem","diesen","dieser","dieses","ich","du","er","sie","es","wir","ihr","sie","Sie","als","an","ans","auch","auf","aufs","aus","bei","fuer","f\u00fcr","nicht","nur","oder","so","und","um","ums","vom","von","in","im"],en:["the","a","an","this","that","these","those","i","you","she","he","it","we","they","as","like","at","to","also","on","of","by","for","not","only","or","so",
"and","about","from","in"],es:["el","la","los","las","un","una","unos","unas","del","al","este","ese","aquel","estos","esos","aquellos","esta","esa","aquella","estas","esas","aquellas","yo","t\u00fa","tus","vos","usted","\u00e9l","ella","ello","nosotros","nosotras","vosotros","vosotras","ustedes","ellos","ellas","en","y","o","a","por","no","ni","desde","e"],fi:["olla","olen","olet","on","olemme","olette","ovat","ole","se","sen","sit\u00e4","siin\u00e4","siit\u00e4","siihen","sill\u00e4","silt\u00e4",
"sille","sin\u00e4","siksi","kanssa"],fr:["le","la","l'","les","un","une","des","du","de","au","aux","ce","cet","cette","ces","je","tu","elle","il","on","nous","vous","elles","ils","comme","\u00e0","aussi","sur","par","pour","ne","n\u2019","pas","ou","or","donc","et","dans"],hu:["a","az","egy","be","ki","le","fel","meg","el","\u00e1t","r\u00e1","ide","oda","sz\u00e9t","\u00f6ssze","vissza","de","h\u00e1t","\u00e9s","vagy","hogy","van","lesz","volt","csak","nem","igen","mint","\u00e9n","te","\u00f5",
"mi","ti","\u00f5k","\u00f6n"],it:["il","lo","la","l'","i","gli","le","un","uno","una","un'","del","dello","della","dell'","dei","degli","degl'","delle","questo","questa","questi","queste","quello","quella","quelli","codesto","codesta","codesti","codeste","io","noi","tu","voi","egli","esso","essi","ella","essa","esse","ad","al","allo","agli","all","agl","alla","alle","con","col","coi","da","dal","dallo","dai","dagli","dall","dagl","dalla","dalle","di","del","dello","dei","degli","dell","degl","della",
"delle","in","nel","nello","nei","nell","negl","nella","nelle","su","sul","sullo","sui","sugli","sull","sugl","sulla","sulle","per","ed","anche","non","a","e","o"],nl:["de","en","van","ik","te","dat","die","in","een","hij","het","niet","zijn","is","was","op","aan","met","als","voor","had","er"],no:["at","en","et","den","til","er","p\u00e5","med","han","av","var","ved","fra","bli","ble","blei","blitt","v\u00e6re","kom","for","\u00e5","blir","v\u00e6rt","v\u00e6re","d\u00e5","ein","eit","eitt","vere",
"vore","verte","vort","varte","vart"],pt:["o","a","os","as","um","uma","uns","umas","esta","estes","estas","aquele","aquela","aqueles","aqueles","aquelas","isto","aquilo","eu","voc\u00ea","ele","ela","n\u00f3s","v\u00f3s","voc\u00eas","eles","elas","de","a","e","em","para","n\u00e3o","no","na","por","como","ou"],ro:["o","unui","unei","unor","cel","cea","cei","cele","celui","celei","celor","al","a","ai","ale","pe","la","\u00een","f\u0103r\u0103","sub","despre","c\u0103tre","cu","de","din","l\u00e2ng\u0103",
"spre","ca","sunt","s","e\u015fti","este","e","suntem","sunte\u0163i","eram","erai","era","era\u0163i","erau","fiu","fii","fie","fim","fi\u0163i","fi","fiind","fost"],sv:["och","det","att","i","en","jag","hon","som","han","p\u00e5","den","med","var","sig","f\u00f6r","s\u00e5","till","\u00e4r","men","ett","om","hade","de","av"],tr:["acaba","altm\u00fd\u00fe","alt\u00fd","ama","bana","baz\u00fd","belki","ben","benden","beni","benim","be\u00fe","bin","bir","biri","birka\u00e7","birkez","bir\u00feey",
"bir\u00feeyi","biz","bizden","bizi","bizim","bu","buna","bunda","bundan","bunu","bunun","da","daha","dahi","de","defa","diye","doksan","dokuz","d\u00f6rt","elli","en","gibi","hem","hep","hepsi","her","hi\u00e7","iki","ile","INSERmi","ise","i\u00e7in","katrilyon","kez","ki","kim","kimden","kime","kimi","k\u00fdrk","milyar","milyon","mu","m\u00fc","m\u00fd","nas\u00fdl","ne","neden","nerde","nerede","nereye","niye","ni\u00e7in","on","ona","ondan","onlar","onlardan","onlari","onlar\u00fdn","onu","otuz",
"sanki","sekiz","seksen","sen","senden","seni","senin","siz","sizden","sizi","sizin","trilyon","t\u00fcm","ve","veya","ya","yani","yedi","yetmi\u00fe","yirmi","y\u00fcz","\u00e7ok","\u00e7\u00fcnk\u00fc","\u00fc\u00e7","\u00feey","\u00feeyden","\u00feeyi","\u00feeyler","\u00feu","\u00feuna","\u00feunda","\u00feundan","\u00feunu"]};return{initialize:function(a,c){var h=B[Kindle.URL.getAmazonDomain()];n=b(a)||b(o())||b(h)||"en-US";v=d(c)||d(l(n))||"US";h=c&&c.toUpperCase()||l(a)||l(o())||l(h)||"US";
q=n.substr(0,2).toLowerCase()+"-"+h},getFormatRegion:k,getUserLanguageCulture:function(){KindleAssert(q,"Language and culture must be set before calling getUserLanguageCulture");return q},getLanguage:c,getLocalizedString:function(a,c,d){var h=n;d&&(h=b(d));d=F(a,h);typeof d!=="string"&&(h!=="en-US"&&(d=F(a,"en-US")),d||(d=a));c&&(d=m(d,c));return d},getLocalizedTime:function(a){return $.format.date(a,h[k()].k_format_time,c())},getLocalTimeOffset:function(){return w},getLocalizedDate:function(a){return $.format.date(a,
h[k()].k_format_date,c())},getLocalizedDateTime:function(a){return $.format.date(a,h[k()].k_format_date_time,c())},getLocalizedArticles:function(){return I[c()]||[]},getLocalizedSearchStopWords:function(a){a=a||c();return E[a]||[]},isLanguageEN:function(){return n.substring(0,2)==="en"},setStringIDMode:function(a){u=!!a},languageCultureNameToRegion:l}}(Kindle.strings,Kindle.formats),KindleO_Aaa=function(){function a(a){for(var c=[],d,s,h,f,k,n,v=0;v<a.length;)h=a.charCodeAt(v++)&255,d=a.charCodeAt(v++),
f=d&255,s=a.charCodeAt(v++),k=s&255,n=h>>2,h=(h&3)<<4|f>>4,f=(f&15)<<2|k>>6,k&=63,isNaN(d)?f=k=64:isNaN(s)&&(k=64),c.push(b.charAt(n)+b.charAt(h)+b.charAt(f)+b.charAt(k));return c.join("")}function f(a){for(var b=[],d,f,h,k,q,n=0;n<a.length;)d=c[a.charCodeAt(n++)],f=c[a.charCodeAt(n++)],k=c[a.charCodeAt(n++)],q=c[a.charCodeAt(n++)],d=d<<2|f>>4,f=(f&15)<<4|k>>2,h=(k&3)<<6|q,b.push(String.fromCharCode(d)),k!==64&&b.push(String.fromCharCode(f)),q!==64&&b.push(String.fromCharCode(h));return b.join("")}
function d(a,b){var c=[];c.length=256;for(var d=0;d<256;d++)c[d]=d;for(var h=0,f,d=0;d<256;d++)h=h+c[d]+b[d%b.length]&255,f=c[d],c[d]=c[h],c[h]=f;for(var h=d=0,k=[],n=0;n<a.length;n++)d=d+1&255,h=h+c[d]&255,f=c[d],c[d]=c[h],c[h]=f,k.push(String.fromCharCode(a.charCodeAt(n)^c[c[d]+c[h]&255]));return k.join("")}for(var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=[],k=0;k<b.length;k+=1)c[b.charCodeAt(k)]=k;return{o_aaa:a,o_aag:f,o_aac:function(b,c){var f;f=b.replace(/\x0d\x0a/g,
"\n");for(var s=[],h=0;h<f.length;h++){var u=f.charCodeAt(h);u<128?s.push(String.fromCharCode(u)):(u>127&&u<2048?s.push(String.fromCharCode(u>>6|192)):(s.push(String.fromCharCode(u>>12|224)),s.push(String.fromCharCode(u>>6&63|128))),s.push(String.fromCharCode(u&63|128)))}f=s.join("");s=c;s+="00000000000000000000000000000000".substring(0,32-s.length);h=[];for(k=0;k<s.length;k+=2)h.push(parseInt(s.substring(k,k+2),16));return a(d(f,h))},o_aad:function(a,b){for(var c=f(a),k=[],h=0;h<b.length;h++)k.push(b.charCodeAt(h));
for(var c=d(c,k),k=[],h=0,u,q,n;h<c.length;)u=c.charCodeAt(h),u<128?(k.push(String.fromCharCode(u)),h++):u>191&&u<224?(q=c.charCodeAt(h+1),k.push(String.fromCharCode((u&31)<<6|q&63)),h+=2):(q=c.charCodeAt(h+1),n=c.charCodeAt(h+2),k.push(String.fromCharCode((u&15)<<12|(q&63)<<6|n&63)),h+=3);return k.join("")}}}(),KindleAppDb=function(a){function f(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb()}function d(a){var b=new jQuery.Deferred;k.getRecord("keyValue",{key:a}).then(function(a){a&&
a.length>0&&b.resolve(a[0].value);b.reject()},b.reject);return b.promise()}function b(a,b){return k.upsertRecord("keyValue",{value:b},{key:a})}function c(a){return k.deleteRecord("keyValue",{key:a})}var k=a;a.updateBookData=function(a,b,c){var d,h,u=[],q=[];for(d in a)q.push(a[d].asin),u.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"bookdata",params:[{asin:a[d].asin}]});for(d in b)a=b[d],u.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:"bookdata",params:[a,{asin:a.asin}]});
h=u.length;c&&u.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:"keyValue",params:[{value:String(c)},{key:"synctime"}]});return k.batchTransaction(u).pipe(function(){function a(){return h}return q.length<1||!f()?(new jQuery.Deferred).resolve(h):f().deleteBooksData(q).pipe(a,a)})};a.getAllBooks=function(){return k.getRecord("bookdata")};a.getAllBooksForContentType=function(a){return k.getRecord("bookdata",{contentType:a})};a.getBook=function(a,b){k.getRecord("bookdata",{asin:a}).done(function(a){b(a.length>
0?a[0]:{})})};a.getBookDataLastSyncTime=function(a){d("synctime").done(function(b){a(b?b:Kindle.DB.NEVER)}).fail(function(){a(Kindle.DB.NEVER)})};a.updateLastPositionRead=function(a,b,c,d){k.updateRecord("bookdata",{lastPositionRead:b,lastTimeRead:c},{asin:a}).fail(d)};a.updateLastFPRSyncTime=function(a,b,c){k.updateRecord("bookdata",{lastFPRSyncTime:b},{asin:a}).fail(c)};a.updateLastReadTime=function(a,b,c,d){k.upsertRecord("bookdata",{lastTimeRead:b,lastFPRSyncTime:c},{asin:a}).fail(d)};a.updateMaxPosition=
function(a,b,c){k.updateRecord("bookdata",{maxPosition:b},{asin:a}).fail(c)};a.getDeviceToken=function(){return d(Kindle.Service.DeviceTokenKey)};a.setDeviceToken=function(a){return b(Kindle.Service.DeviceTokenKey,a)};a.clearDeviceToken=function(){return c(Kindle.Service.DeviceTokenKey)};a.getUserHashId=function(){return d(Kindle.Service.UserHashIdKey)};a.setUserHashId=function(a){return b(Kindle.Service.UserHashIdKey,a)};a.clearUserHashId=function(){return c(Kindle.Service.UserHashIdKey)};a.getEID=
function(){return d(Kindle.Service.EidKey)};a.setEID=function(a){return b(Kindle.Service.EidKey,a)};a.clearEID=function(){return c(Kindle.Service.EidKey)};a.getValueForKey=d;a.setValueForKey=b;a.removeValueForKey=c;a.getValuesForKeys=function(a){for(var b=[],c=new jQuery.Deferred,d=0;d<a.length;d++)b.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:"keyValue",params:[{key:a[d]}]});k.batchTransaction(b).then(function(a){for(var b,d={},f=0;f<a.length;f++)if(a[f]&&a[f].length)b=a[f][0],d[b.key]=
b.value;c.resolve(d)},c.reject);return c.promise()};a.getCachedAsins=function(a,b){function c(b){var h,f=[];for(h=0;h<b.length;h++)a.indexOf(b[h].cacheState)>=0&&f.push(b[h]);d.resolve(f)}var d=jQuery.Deferred();if(f()){var h={asin:!0,cacheState:!0,cachedSize:!0,context:!!b};f().getRecord("bookinfo",null,h).then(a?c:d.resolve,d.reject)}else d.resolve([]);return d.promise()};a.getCachedCovers=function(){function a(c){var d,h={};for(d=0;d<c.length;d++)h[c[d].asin]=c[d].coverData;b.resolve(h)}var b=
new jQuery.Deferred;f()?f().getRecord("covers",null).then(a,b.reject):a([]);return b.promise()};a.getBookCachedState=function(a){return f()?f().getRecord("bookinfo",{asin:a},{cacheState:!0}):(a=new jQuery.Deferred,a.resolve([]),a.promise())};a.getPinnedSessionIds=function(){function a(b){var d,f=[];if(b)for(d=0;d<b.length;d++)f.push(b[d].context.kindleSessionId);c.resolve(f)}function b(){c.resolve([])}var c=new jQuery.Deferred;f()?f().getRecord("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PINNED},
{context:!0}).then(a,b):c.resolve([]);return c.promise()};return a},KindleBookDb=function(a){function f(){switch(KindleHostDeviceDetector.getDevicePlatform()){case "iPad":case "iPhone":case "playBook":return 5E7;case "desktop":return KindleHostDeviceDetector.isIE()?25E7:Number.MAX_VALUE;default:return 5E7}}function d(a,b){var c={},d;for(d in a)a.hasOwnProperty(d)&&!b[d]&&(c[d]=a[d]);c=JSON.stringify(c);return c==="{}"?"":c}function b(a,b){if(b){var c=JSON.parse(b),d;for(d in c)c.hasOwnProperty(d)&&
(a[d]=c[d])}return a}function c(a,b,c,d,e,h){var f=Date.now();y.getRecord(a,{asin:c,id:{operator:Kindle.DB.IN_ARRAY,values:d}}).then(function(a){b(a,f,e)},function(a){h(a)})}function k(a,b,c,d,e,h){Date.now();var f=0,k,w=[],l;for(l in d)k=b(c,d[l]),f+=k.size,w.push(k);y.insertList(a,w).then(function(){Date.now();e(f)},function(a){h(a)})}function m(a,b,c,d){var e=KindleMetricsProfiler("getIds:"+a);y.getPieceIds(a,b).then(function(a){e.addCount(b,a.length);e.endTimer();e.log();c(a)},function(a){d(a)})}
function l(a,c,d){Date.now();var c=[],h=0,e;for(e in a){var f=a[e],k=f.id;h+=f.piece.length+f.metadata.length;c[k]=b({fragmentData:f.piece,fragmentMetadata:JSON.parse(f.metadata)},f.other)}d(c)}function o(a,b){var c=b.fragmentData,h=JSON.stringify(b.fragmentMetadata),e=d(b,{fragmentData:1,fragmentMetadata:1});return{asin:a,id:b.fragmentMetadata.id,size:c.length+h.length+e.length,piece:c,metadata:h,other:e}}function s(a,c,d){Date.now();var c=[],h;for(h in a){var e=a[h];c[e.id]=b({skeletonData:e.piece,
skeletonMetadata:JSON.parse(e.metadata)},e.other)}d(c)}function h(a,b){var c=b.skeletonData,h=JSON.stringify(b.skeletonMetadata),e=d(b,{skeletonData:1,skeletonMetadata:1});return{asin:a,id:b.skeletonMetadata.id,size:c.length+h.length+e.length,piece:c,metadata:h,other:e}}function u(a,c,d){Date.now();var c=[],h=0,e;for(e in a){var f=a[e],k=f.id;h+=f.piece.length+f.metadata.length;c[k]=b({glyphData:JSON.parse(f.piece),glyphFragmentMetadata:JSON.parse(f.metadata)},f.other)}d(c)}function q(a,b){var c=
JSON.stringify(b.glyphData),h=JSON.stringify(b.glyphFragmentMetadata),e=d(b,{glyphData:1,glyphFragmentMetadata:1});return{asin:a,id:b.glyphFragmentMetadata.id,size:c.length+h.length+e.length,piece:c,metadata:h,other:e}}function n(a,c,d){Date.now();var c=[],h=0,e;for(e in a){var f=a[e],k=f.id;h+=f.piece.length+f.metadata.length;c[k]=b({data:JSON.parse(f.piece),metadata:JSON.parse(f.metadata)},f.other)}d(c)}function v(a,b){var c=JSON.stringify(b.data),h=JSON.stringify(b.metadata),e=d(b,{data:1,metadata:1});
return{asin:a,id:b.metadata.id,size:c.length+h.length+e.length,piece:c,metadata:h,other:e}}function w(a,c,d){Date.now();var c=[],h=0,e;for(e in a){var f=a[e],k=f.id;h+=f.piece.length+f.metadata.length;c[k]=b({locations:JSON.parse(f.piece),metadata:JSON.parse(f.metadata)},f.other)}d(c)}function C(a,b){var c=JSON.stringify(b.locations),h=JSON.stringify(b.metadata),e=d(b,{locations:1,metadata:1});return{asin:a,id:b.metadata.id,size:c.length+h.length+e.length,piece:c,metadata:h,other:e}}function B(a){return y.dbDeleteBooksData(a)}
function F(a){return y.dbGetBookStatistics(a)}function I(){var a=new jQuery.Deferred;y.getRecord("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PINNED},{cachedSize:!0}).then(function(b){var c=0,d;for(d in b)c+=b[d].cachedSize;a.resolve(c)},function(){a.reject()});return a.promise()}function E(){var a=new jQuery.Deferred,b=f();b===Number.MAX_VALUE?a.resolve(Number.MAX_VALUE):I().then(function(c){c=b-1E6-c*2.4;c=Math.round(c/2.4);a.resolve(c)},function(){a.resolve(0)});return a.promise()}function K(b){function d(){var a=
new jQuery.Deferred;E().then(function(b){L=b;a.resolve(b)},function(){L=0;a.resolve()});return a.promise()}var f=0,L=0;return{getFragments:function(a){var d=new jQuery.Deferred;c("fragments",l,b,a,d.resolve,d.reject);return d.promise()},putFragments:function(a){var c=new jQuery.Deferred;k("fragments",o,b,a,function(a){f+=a;c.resolve(a)},c.reject);return c.promise()},getFragmentIds:function(){var a=new jQuery.Deferred;m("fragments",b,a.resolve,a.reject);return a.promise()},getSkeletons:function(a){var d=
new jQuery.Deferred;c("skeleton",s,b,a,d.resolve,d.reject);return d.promise()},putSkeletons:function(a){var c=new jQuery.Deferred;k("skeleton",h,b,a,function(a){f+=a;c.resolve(a)},c.reject);return c.promise()},getSkeletonIds:function(){var a=new jQuery.Deferred;m("skeleton",b,a.resolve,a.reject);return a.promise()},getGlyphs:function(a){var d=new jQuery.Deferred;c("glyphs",u,b,a,d.resolve,d.reject);return d.promise()},putGlyphs:function(a){var c=new jQuery.Deferred;k("glyphs",q,b,a,function(a){f+=
a;c.resolve(a)},c.reject);return c.promise()},getGlyphIds:function(){var a=new jQuery.Deferred;m("glyphs",b,a.resolve,a.reject);return a.promise()},getResources:function(a){var d=new jQuery.Deferred;c("resources",n,b,a,d.resolve,d.reject);return d.promise()},putResources:function(a){var c=new jQuery.Deferred;k("resources",v,b,a,function(a){f+=a;c.resolve(a)},c.reject);return c.promise()},getResourceIds:function(){var a=new jQuery.Deferred;m("resources",b,a.resolve,a.reject);return a.promise()},getLocationMaps:function(a){var d=
new jQuery.Deferred;c("locations",w,b,a,d.resolve,d.reject);return d.promise()},putLocationMaps:function(a){var c=new jQuery.Deferred;k("locations",C,b,a,function(a){f+=a;c.resolve(a)},c.reject);return c.promise()},getLocationMapIds:function(){var a=new jQuery.Deferred;m("locations",b,a.resolve,a.reject);return a.promise()},getAnnotations:function(){return y.getRecord("annotationsCache",{asin:b},{annotationsData:!0}).pipe(function(a){if(a&&a.length===1)return a[0].annotationsData})},putAnnotations:function(a){return y.insertRecord("annotationsCache",
{asin:b,annotationsData:a})},getBookInfo:function(){var a=new jQuery.Deferred;y.getRecord("bookinfo",{asin:b}).then(function(b){b.length===1?(f=b[0].cachedSize||0,a.resolve(b[0])):a.reject()},a.reject);return a.promise()},insertBookInfo:function(a){a=$.extend(!0,{},a,{asin:b,openTime:Date.now()});return y.insertRecord("bookinfo",a)},updateBookInfo:function(a){a=$.extend({openTime:Date.now()},a);return y.updateRecord("bookinfo",a,{asin:b})},getBookStatistics:function(){var a=new jQuery.Deferred;F(b).then(function(c){c.totalSize!==
c.cachedSize?(f=c.cachedSize=c.totalSize,y.updateRecord("bookinfo",{cachedSize:f},{asin:b}).then(function(){a.resolve(c)},a.reject)):a.resolve(c)},a.reject);return a.promise()},getCacheQuota:function(){return{cachedSize:f,cacheQuota:L}},computeCacheQuota:function(){return d().promise()},deleteOldestBookData:function(b){return a.deleteOldestBookData(b)},deleteBooksData:function(b){return a.deleteBooksData(b)},deleteSearchIndex:function(){return y.deleteRecord("searchIndex",{asin:b})},getPageNumbers:function(){return y.getRecord("pageNumberCache",
{asin:b},{pageNumberData:!0}).pipe(function(a){if(a&&a.length===1)return a[0].pageNumberData})},putPageNumbers:function(a){return y.insertRecord("pageNumberCache",{asin:b,pageNumberData:a})},getSearchIndex:function(){return y.getSearchIndexData(b)},putSearchIndex:function(a){return y.putSearchIndexData(b,a)},reserveStorage:function(a){function b(){h=setTimeout(function(){h=null;y.dropTable(d)},1E3)}function c(){var a=new ArrayBuffer(j*1024),a=new Blob([a]);y.insertRecord(d,{asin:"0000000000",id:f,
data:a}).then(function(){h&&(clearTimeout(h),--f>0?(b(),c()):y.dropTable(d))},function(){h&&(clearTimeout(h),y.dropTable(d))})}var d="reservedStorage",j=100,f=a*1024/j,h;b();c()},getFilteredSearchIndexAsins:function(a){var b=$.Deferred();y.getRecord("searchIndex",{asin:{operator:Kindle.DB.IN_ARRAY,values:a}},{asin:!0}).then(function(a){a=a.map(function(a){return a.asin}).sort().filter(function(a,b,c){return b===0||c[b-1]!==c[b]});b.resolve(a)},b.reject);return b.promise()}}}var y=a,z=null,D=0;a.deleteBooksData=
B;a.deleteOtherBooksData=function(a){for(var b=new jQuery.Deferred,c=["fragments","glyphs","skeleton","bookinfo","annotationsCache","covers","searchIndex","pageNumberCache"],d=[],e=0;e<c.length;e++)d.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:c[e],params:[{asin:{operator:Kindle.DB.NOT_EQUAL,values:[a]}}]});y.batchTransaction(d).then(function(){b.resolve()},function(a){b.reject(a)});return b.promise()};a.deleteOldestBookData=function(a){function b(){z.resolve(arguments);z=null}function c(){z.reject(arguments);
z=null}function d(e){function f(a){for(var b=function(){return a&&a.length>0?e.filter(function(b){return a.indexOf(b.asin)>=0}):e}(),c=b[0],d=1;d<b.length;d++)b[d].openTime<c.openTime&&(c=b[d]);return c.asin}function h(){B([f()]).then(b,c)}if(!e||e.length===0)KindleHostDeviceDetector.isIE()&&D===0?(b(),D++):(KindleDebug.warn("trying to delete oldest asin, but got no list of books"),D=0,c());else{D=0;var k=e.map(function(a){return a.asin});K(a).getFilteredSearchIndexAsins(k).done(function(a){a&&a.length>
0?K(f(a)).deleteSearchIndex().then(b,c):h()}).fail(h)}}z||(z=new jQuery.Deferred,y.getOldBookList(a).then(d,c));return z};a.getBookStatistics=F;a.updateBookInfos=function(a){var b=[],c;for(c in a){var d={},e;for(e in a[c])d[e]=a[c][e];b.push({operation:Kindle.DB.UPDATE_RECORD_OPERATION,tableName:"bookinfo",params:[d,{asin:c}]})}return y.batchTransaction(b)};a.BookInfoDB=K;return a},KindleDBClient=function(){function a(){if(!F)throw{name:"databaseInitializationError",message:"Please call initialize function first"};
}function f(a){var b=$.extend({appDb:E},a);C.callEventListeners(a.type,b)}function d(a){var b=$.extend({bookDb:K},a);C.callEventListeners(a.type,b)}function b(a){var b=new jQuery.Deferred;a.wrapper?a.wrapper.dropTables().then(b.resolve,b.reject,b.notify):b.resolve();return b.promise()}function c(a){if(I)return I.promise();I=new jQuery.Deferred;J.initDfd=new jQuery.Deferred;var b=KindleStubDBWrapper(P);u(!1);b.createTables(M,J.version).then(function(){m(b);KindleAppDb(b);J.wrapper=b;J.initDfd.resolve(b);
y=E=b;F=!0;I.resolve(a)},function(a){I.reject(a)});return I.promise()}function k(){function a(){++j===d&&(y=null,KindleStubDBWrapper(P).dropTables(),c.resolve())}function b(g){return function(b){var e=[],d;for(d in b)e.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:g,params:[b[d],b[d]]});E.batchTransaction(e).then(a,c.reject)}}var c=new jQuery.Deferred;if(!y)return c.resolve(),c.promise();var e=y.getTableNames(),d=e.length,j=0,f;for(f in e)y.getRecord(e[f]).then(b(e[f]),c.reject);return c.promise()}
function m(a){function b(g){return{tableName:g,insertRecord:function(b){return a.insertRecord(g,b)},insertList:function(b){return a.insertList(g,b)},updateRecord:function(b,c){return a.updateRecord(g,b,c)},getRecord:function(b,c){return a.getRecord(g,b,c)},deleteRecord:function(b){return a.deleteRecord(g,b)},batchTransaction:function(b){var c;for(c=0;c<b.length;c++)b[c].tableName=g;return a.batchTransaction(b)}}}var c=a.getTableNames(),e,d;for(d in c)e=c[d],Q[e]=b(e);a.getTable=function(a){return Q[a]}}
function l(a){a.onversionchange=function(a){J.handle&&J.handle.close();O.handle&&O.handle.close();a&&a.target&&a.target.close&&typeof a.target.close==="function"&&a.target.close();setTimeout(function(){function a(){window.location.reload(!0)}_metricsManager.emitNow("App::DatabaseGoneOnVersionZero",{breakdown:["Browser"]}).then(a,a)},500)}}function o(){function a(){m(b);KindleAppDb(b);J.wrapper=b;J.initDfd.resolve(b)}var b={};if(!J.initDfd)J.initDfd=new jQuery.Deferred,KindleHostDeviceDetector.isWebSQLSupported()?
(b=KindleSqlWrapper(J),b.flavor="websql",b.openDatabase().then(function(b){J.handle=b;a();KindleLocalStorage.setItem("haveDB","1")},J.initDfd.reject)):KindleHostDeviceDetector.isIndexedDBSupported()?(b=KindleIDBWrapper(J),b.flavor="IndexedDB",b.openDatabase().done(function(b){l(b);J.handle=b;KindleLocalStorage.setItem("haveDB","1");a()}).fail(J.initDfd.reject)):c(this);return J.initDfd.promise()}function s(){function a(){m(b);KindleBookDb(b);O.wrapper=b;O.initDfd.resolve(b)}var b={};if(!O.initDfd){O.initDfd=
new jQuery.Deferred;try{KindleHostDeviceDetector.isWebSQLSupported()?(b=KindleSqlWrapper(O),b.openDatabase().then(function(c){O.handle=c;a(b)},O.initDfd.reject)):KindleHostDeviceDetector.isIndexedDBSupported()?(b=KindleIDBWrapper(O),b.openDatabase().done(function(b){l(b);O.handle=b;a()}).fail(O.initDfd.reject)):O.initDfd.reject("nodb")}catch(c){O.initDfd.reject()}}return O.initDfd.promise()}function h(){if(KindleHostDeviceDetector.isChromeApp())return!0;if((KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE())&&
KindleLocalStorage.getItem("haveDB"))return!0;var a=KindleLocalStorage.getItem("booksdb");if(a==="true")return!0;else if(a==="false")return!1}function u(a){KindleLocalStorage.setItem("booksdb",a?"true":"false")}function q(){var a;a=new jQuery.Deferred;if(K)return a.resolve(K),a.promise();var b;b=!KindleHostDeviceDetector.isWebSQLSupported()&&!KindleHostDeviceDetector.isIndexedDBSupported()?!1:KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()?!1:!0;if(!b)return a.reject(),
a.promise();O.initDfd=null;s().then(function(b){K=b;u(!0);a.resolve(K)},function(){u(!1);a.reject()});return a.promise()}function n(){var a;a=new jQuery.Deferred;if(E&&E!==y)return a.resolve(E).promise();J.initDfd=null;o().then(function(b){E=b;a.resolve(E)},function(){a.reject()});return a.promise()}function v(){function a(){E=y;KindleLocalStorage.removeItem("haveDB");D=z.memAppDb}function b(){D=z.dbBookDb}function c(e){return k().pipe(function(){E=e;y=null;KindleLocalStorage.removeItem(P);D=z.dbAppDb;
return q().pipe(b)},a)}var e;switch(D){case z.dbBookDb:e=$.Deferred().resolve();break;case z.dbAppDb:e=q().pipe(b);break;case z.memAppDb:e=n().pipe(c,a)}return e.promise()}function w(){function a(b,g){E=b;D=(K=g)?z.dbBookDb:z.dbAppDb;F=!0;B.resolve(R)}function b(g){$.when(h()?s():null).then(function(b){D=z.dbBookDb;a(g,b)},function(){D=z.dbAppDb;a(g,null)})}function e(){D=z.memAppDb;c(R).done(B.resolve)}if(!B)B=new jQuery.Deferred,(KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE()?
KindleLocalStorage.getItem("haveDB"):1)?o().then(b,e):(D=z.memAppDb,c(R).done(B.resolve));return B.promise()}var C=ListenerManager(),B=null,F=!1,I=null,E=null,K=null,y=null,z={none:"none",memAppDb:"memAppDb",dbAppDb:"dbAppDb",dbBookDb:"dbBookDb"},D=z.none,j=Kindle.DB.TEXT_TYPE,t=Kindle.DB.NUMBER_TYPE,r=Kindle.DB.OBJECT_TYPE,L=Kindle.DB.BLOB_TYPE,e=Kindle.DB.ALLOW_NULL,A=Kindle.DB.PRIMARY_KEY,N=Kindle.DB.PIECE_ID_TYPE,P="app_db_storage",M={bookdata:{asin:j|A,contentType:j|e,title:j|e,authors:r|e,purchaseDate:t|
e,maxPosition:t|e,lastTimeRead:t|e,lastPositionRead:t|e,lastFPRSyncTime:t|e,authorPronunciations:r|e,titlePronunciation:j|e},keyValue:{key:j|A,value:j|e},metrics:{method:j,time:t,timers:r|e,counters:r|e,breakDown:r|e},journal:{id:Kindle.DB.AUTO_INCREMENT,entry:r}},j={bookinfo:{asin:j|A,cacheState:j|Kindle.DB.SECONDARY_KEY,cachedSize:t|e,openTime:t,context:r,metadata:r,manifest:r,fragmap:r},skeleton:{asin:j|A,id:t|A|N,size:t,piece:j,metadata:j,other:j},fragments:{asin:j|A,id:t|A|N,size:t,piece:j,metadata:j,
other:j},glyphs:{asin:j|A,id:t|A|N,size:t,piece:j,metadata:j,other:j},resources:{asin:j|A,id:t|A|N,size:t,piece:j,metadata:j,other:j},locations:{asin:j|A,id:t|A|N,size:t,piece:j,metadata:j,other:j},annotationsCache:{asin:j|A,annotationsData:r},covers:{asin:j|A,coverData:j},searchIndex:{asin:j|A,component:j|A,data:L},pageNumberCache:{asin:j|A,pageNumberData:r},reservedStorage:{asin:j|A,id:j|A,data:L}},Q={},J={shortName:"K4W",version:2,displayName:"Kindle Cloud Reader",defaultSize:5E6,initDfd:null,
wrapper:null,handle:null,tables:M,versionUpdate:[{version:2,tableName:"bookdata",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["contentType"]},{version:2,tableName:"bookdata",operation:Kindle.DB.UPDATE_RECORD_OPERATION,params:[{contentType:"EBOK"}]},{version:3,tableName:"bookdata",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["authorPronunciations","titlePronunciation"]}]},O={shortName:"K4Wbooks",version:7,displayName:"Kindle Cloud Reader Books",defaultSize:5E7,initDfd:null,wrapper:null,handle:null,
tables:j,versionUpdate:[{version:4,tableName:"bookinfo",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["manifest"]},{version:5,tableName:"searchIndex",operation:Kindle.DB.CREATE_TABLE_OPERATION,params:[j.searchIndex]},{version:6,tableName:"pageNumberCache",operation:Kindle.DB.CREATE_TABLE_OPERATION,params:[j.pageNumberCache]},{version:7,tableName:"reservedStorage",operation:Kindle.DB.CREATE_TABLE_OPERATION,params:[j.reservedStorage]}]},R={enableFullDb:function(){return v(this)},getAppDb:function(){a();
return E},getBookDb:function(){a();return K},bookDbEnabled:h,persistDB:function(){E&&E.persist&&E.persist();K&&K.persist&&K.persist()},clear:function(a,g){function c(){J.wrapper=null;E=J.initDfd=null;O.wrapper=null;y=K=O.initDfd=null;F=!1;I=_initializeFullDeferred=null;e.resolve()}var e=new jQuery.Deferred;(function(){function a(b){b=Number(b)||0;e.notify({clearDbAttempts:b});return J.wrapper.setValueForKey("clearDbAttempts",b+1)}return J.wrapper.getValueForKey("clearDbAttempts").pipe(a,a)})().always(function(){b(J).then(function(){b(O).then(c,
e.reject)},e.reject,e.notify)});e.then(a,g);return e.promise()},addEventListener:function(a,b){E&&E.addEventListener&&E.addEventListener(a,f);K&&K.addEventListener&&K.addEventListener(a,d);C.addEventListener(a,b)},removeEventListener:function(a,b){C.removeEventListener(a,b)}};return{initialize:function(){KindleModuleManager.define(Kindle.MODULE.DB_CLIENT,[Kindle.MODULE.APPLICATION_ARGS],w)}}}();
function KindleIDBWrapper(a){function f(a,b){b=b||{};b.type=b.type||a;N.callEventListeners(a,b)}function d(a){if(!A[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function b(){var a=[],b;for(b in A)a.push(b);return a}function c(a,b,c){if(A[a].info[b]&Kindle.DB.PIECE_ID_TYPE){for(a=""+c;a.length<t;)a="0"+a;return a}else return c}function k(a,b){if(a&&b){d(b);var e=A[b],f="";if(e.genKeyPath)for(var e=e.keyList,h=0;h<e.length;++h){if(a[e[h]]===void 0){f=void 0;break}f+=
c(b,e[h],a[e[h]]);h<e.length-1&&(f+=j)}else f=a[e.keyPath];return f}}function m(a,b,e){for(var d="",f,h,r=0;r<b.length;++r){f=b[r];h=e[f];if(!h)break;h=h.hasOwnProperty(Kindle.DB.OPERATOR)?h[Kindle.DB.VALUES][0]:h;d+=c(a,f,h);r<b.length-1&&(d+=j)}return d}function l(a,b,e){var d="",f,h,r;for(r=0;r<b.length;++r){h=b[r];f=e[h];if(!f)throw{name:"CreateUpperBoundException",message:"Need at least the root primary key to create an upper bound"};if(f.hasOwnProperty(Kindle.DB.OPERATOR)){var k=f[Kindle.DB.VALUES][f[Kindle.DB.VALUES].length-
1];if(typeof k==="number")f=f[Kindle.DB.VALUES][f[Kindle.DB.VALUES].length-1];else if(typeof k==="string")f=k;else throw{name:"InvalidKeyException",message:"Tried to generate a lowerbound key with invalid keys"};}d+=c(a,h,f);r<b.length-1&&(d+=j)}return d}function o(a,b){for(var c=Date.now()-2E3,e=0;e<Q.length;e++)if(Q[e].id===a){Q[e].time<c&&KindleDebug.log("Long write: "+(Date.now()-Q[e].time));Q.splice(e,1);break}Q.length===0&&(clearInterval(R),R=null);J&&(J=!1,f(Kindle.ERROR.DB_LINGERING_WRITE,
{stalled:!1,writeOk:b}))}function s(){var a=Date.now()-5E3;Q.some(function(b){return b.time<a&&!b.warned})&&(Q.forEach(function(a){a.warned=!0}),J=!0,f(Kindle.ERROR.DB_LINGERING_WRITE,{stalled:!0}))}function h(a,b,c){var d,j=new jQuery.Deferred,f=new jQuery.Deferred,h=$.makeArray(a),r;c===M?(R||(R=setInterval(s,5E3)),Q.push({id:++O,time:Date.now(),warned:J}),r=O):r=0;var k=r;try{d=e.transaction(h,c)}catch(t){return j.reject().promise()}d.oncomplete=function(){k&&o(k,!0);f.then(j.resolve,j.reject)};
d.onerror=function(a){k&&o(k,!1);j.reject(a)};d.onabort=function(){k&&o(k,!1);j.reject({code:Kindle.DB.QUOTA_ERR,message:"Assumed QUOTA_ERR"})};b(d,a,f);return j.promise()}function u(a,b,c){function e(){++d===j&&w.resolve(C)}for(var d=0,j=c.length,f=A[b].tableInfo,h=A[b].keyPath,r=A[b].genKeyPath,t=A[b].autoInc,w=new jQuery.Deferred,l,C=[],m=0;m<c.length;m++){for(var v in c[m])l=f[v],l&Kindle.DB.TEXT_TYPE?c[m][v]=typeof c[m][v]==="string"?c[m][v]:String(c[m][v]):l&Kindle.DB.NUMBER_TYPE&&(c[m][v]=
typeof c[m][v]==="number"?c[m][v]:Number(c[m][v]));!t&&!c[m][h]?(l=r?k(c[m],b):h,l=a.put(c[m],l)):l=t?a.add(c[m]):a.put(c[m]);l.onsuccess=e;l.onerror=w.reject;C.push(c[m])}return w.promise()}function q(a,b){if(!a||!b)throw{name:"databaseInsertError",message:"Tried to insert with an empty table name or empty object list"};d(a);return h(a,function(a,c,e){a=a.objectStore(c);u(a,c,b).then(e.resolve,e.reject)},M)}function n(a,b,c){function e(a,b){return a-b}d(b);var j=c?$.extend(!0,{},c):c,f,h=A[b].tableInfo,
r=A[b].keyPath,c=A[b].keyList,t=A[b].autoInc,w=new jQuery.Deferred,C=!1,v;if(j)for(var o in j){var L=j[o];if(L){var B=h[o],L=L.hasOwnProperty(Kindle.DB.OPERATOR);if(B&Kindle.DB.TEXT_TYPE)if(L){for(var u in j[o][Kindle.DB.VALUES])B=j[o][Kindle.DB.VALUES][u],j[o][Kindle.DB.VALUES][u]=typeof B==="string"?B:String(B);j[o][Kindle.DB.VALUES].sort()}else typeof j[o]!=="string"&&(j[o]=String(j[o]));else if(B&Kindle.DB.NUMBER_TYPE)if(L){for(var F in j[o][Kindle.DB.VALUES])B=j[o][Kindle.DB.VALUES][F],j[o][Kindle.DB.VALUES][F]=
typeof B==="number"?B:Number(B);j[o][Kindle.DB.VALUES].sort(e)}else typeof j[o]!=="number"&&(j[o]=Number(j[o]));!C&&L&&(C=!0)}}!C&&j&&(j[r]?f=j[r]:t||(f=k(j,b)));if(f)v=a.get(f),v.onsuccess=function(a){(a=a.target.result)?w.resolve([a]):w.resolve([])},v.onerror=w.reject;else{var s=[],q;if(j){f=!0;for(var n in c)if(!j[c[n]]){f=!1;break}if(f)f=m(b,c,j),b=l(b,c,j),b=IDBKeyRange.bound(f,b,!1,!1),v=a.openCursor(b);else{n={};for(var I in c)if(j[c[I]]){q=c[I];n[q]=j[q];break}if(!q){for(var E in j)if(j[E].hasOwnProperty(Kindle.DB.OPERATOR)){q=
E;n[E]=j[E];break}q||(q=Object.keys(j)[0])}n[q]&&n[q].hasOwnProperty(Kindle.DB.OPERATOR)?(f=m(b,[q],n),b=l(b,[q],n),b=IDBKeyRange.bound(f,b,!1,!1)):b=IDBKeyRange.only(j[q]);try{v=a.index(q).openCursor(b)}catch(y){v=a.openCursor()}}}else v=a.openCursor();v.onerror=w.reject;v.onsuccess=function(a){var a=a.target.result,b=!0;if(a){for(var c in j){var e=j[c];if(e){if(e.hasOwnProperty(Kindle.DB.OPERATOR))switch(b=$.inArray(a.value[c],e[Kindle.DB.VALUES])!==-1,e[Kindle.DB.OPERATOR]){case Kindle.DB.NOT_EQUAL:b=
!b}else e!==a.value[c]&&(b=!1);if(!b)break}}b&&s.push(a.value);a["continue"]()}else w.resolve(s)}}return w.promise()}function v(a,b,c){var e=c[0],c=c[1],d=new jQuery.Deferred;n(a,b,c).then(function(c){if(c.length>0){for(var j in c)c[j]=$.extend(c[j],e);u(a,b,c).then(d.resolve,d.reject)}else d.resolve(c)},d.reject);return d.promise()}function w(a,b,c){return h(a,function(a,e,g){a=a.objectStore(e);v(a,e,[b,c]).then(g.resolve,g.reject)},M)}function C(a,b,c){var e=new jQuery.Deferred;v(a,b,c).then(function(d){d.length===
0?(c[0]=$.extend(c[0],c[1]),u(a,b,[c[0]]).then(e.resolve,e.reject)):e.resolve(d)},e.reject);return e.promise()}function B(a,b,c){return n(a,b,c[0])}function F(a,b,c){return h(a,function(a,e,g){a=a.objectStore(e);B(a,e,[b]).then(function(a){if(c)for(var b in a)for(var e in a[b])e in c||delete a[b][e];g.resolve(a)},g.reject)},P)}function I(a,b,c){function e(c){function f(){return function(){++h===c.length&&d.resolve()}}var h=0;if(c.length===0)d.resolve();else for(var r in c){var t=k(c[r],b);j=a["delete"](t);
j.onsuccess=f(t,c[r]);j.onerror=d.reject}}var c=c[0],d=new jQuery.Deferred,j;c?n(a,b,c).then(e,d.reject):(j=a.clear(),j.onsuccess=d.resolve,j.onerror=d.reject);return d.promise()}function E(a){for(var b=new jQuery.Deferred,c=e.transaction(a,M),d=0;d<a.length;d++)c.objectStore(a[d]).clear().onerror=b.reject;c.oncomplete=b.resolve;c.onabort=b.reject;c.onerror=b.reject;return b.promise()}function K(){var b=new jQuery.Deferred;e.onversionchange=function(){e.close();e=void 0};e.close();var c=window.indexedDB.deleteDatabase(a.shortName);
c.onsuccess=function(){b.resolve()};c.onerror=function(){b.reject()};c.onblocked=function(){b.notify({blocked:!0})};return b.promise()}function y(){return z(function(a){return a.value})}function z(a){return h("bookinfo",function(b,c,e){var d=[],b=b.objectStore(c).openCursor();b.onsuccess=function(b){if(b=b.target.result){var c=a(b);c&&d.push(c);b["continue"]()}else e.resolve(d)};b.onerror=e.reject},P)}function D(a){function c(a){w.reject(a)}function d(a){w.reject(a)}function j(a){if(a=a.target.result)a["delete"](),
a["continue"]()}function f(){}var h=b(),t,w,l,v,m,C,o,B;w=new jQuery.Deferred;C=e.transaction(h,M);C.oncomplete=function(){w.resolve()};C.onerror=c;C.onabort=c;for(l=0;l<a.length;++l){v=a[l];m=k({asin:v,id:0},"skeleton");B=k({asin:v,id:r},"skeleton");B=IDBKeyRange.bound(m,B);for(m=0;m<h.length;m++)t=A[h[m]],o=C.objectStore(h[m]),t.genKeyPath?(t=o.openCursor(B),t.onsuccess=j):(t=o["delete"](v),t.onsuccess=f),t.onerror=d}return w.promise()}var j=String.fromCharCode(31),t=8,r="99999999",L=a,e=null,A=
{},N=ListenerManager(),P=IDBTransaction.READ_ONLY||"readonly",M=IDBTransaction.READ_WRITE||"readwrite",Q=[],J=!1,O=1,R=null,T={};T[Kindle.DB.INSERT_LIST_OPERATION]=u;T[Kindle.DB.UPDATE_RECORD_OPERATION]=v;T[Kindle.DB.UPSERT_RECORD_OPERATION]=C;T[Kindle.DB.DELETE_RECORD_OPERATION]=I;T[Kindle.DB.GET_RECORD_OPERATION]=B;T[Kindle.DB.CREATE_TABLE_OPERATION]=function(){KindleDebug.error("Illegal function: doCreateTable")};if(!function(a){var b,c;for(c in a){b=c;var e=!0,d=!1,f=void 0,h=[],r=[],t="",k=[],
w=a[c],l=void 0;for(l in w){f=w[l];if(f&Kindle.DB.AUTO_INCREMENT||f&Kindle.DB.PRIMARY_KEY)d?e=!1:(d=!!(f&Kindle.DB.AUTO_INCREMENT))||h.push(l);f&(Kindle.DB.PRIMARY_KEY|Kindle.DB.SECONDARY_KEY)&&k.push({name:l,keyPath:l,unique:!1,multientry:!1})}if(e){for(var f=!1,m=0;m<h.length;++m)t+=h[m],r[m]=w[l],m<h.length-1&&(t+=j,f=!0);h.length===0&&(d=!0);A[b]={info:w,keyList:h,keyPath:t?t:void 0,genKeyPath:f,genKeyTypes:r,indexes:k,autoInc:d,tableInfo:w}}b=e;if(b&Kindle.DB.CONSTRAINT_ERROR)return!1}return!0}(a.tables))throw Error("Invalid table description for "+
a.shortName);return{createTables:function(){KindleDebug.error("Called deprecated createTables function")},openDatabase:function(){var a=new jQuery.Deferred,b;window.indexedDB=window.indexedDB||window.mozIndexedDB||window.msIndexedDB||window.webkitIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction;b=window.indexedDB.open(L.shortName,L.version);b.onsuccess=function(b){e=b.target.result;a.resolve(e)};b.onerror=function(b){a.reject(b)};b.onupgradeneeded=function(a){var c;
a:{c=L.tables;var a=a.target.result,e,d,g;g=a.objectStoreNames;for(e=0;e<g.length;e++)d=g[e],c.hasOwnProperty(d)||a.deleteObjectStore(d);for(d in c)if($.inArray(d,g)===-1){var j=a;e=d;if(A[e]===void 0)e=Kindle.DB.CONSTRAINT_ERR;else{var f={autoIncrement:A[e].autoInc};if(!f.autoIncrement&&!A[e].genKeyPath)f.keyPath=A[e].keyPath;var j=j.createObjectStore(e,f),h=f=void 0;for(h in A[e].indexes)f=A[e].indexes[h],j.createIndex(f.name,f.keyPath,{unique:f.unique});e=null}if(e&Kindle.DB.CONSTRAINT_ERR){c=
!1;break a}}c=!0}c||b.abort()};return a.promise()},dropTable:function(a){return E([a])},dropTables:function(){function a(){y().then(b,f)}function b(a){function e(){d(a).then(j,f)}a.length===0?j():c(a).then(e,f)}function c(a){function b(){++d===a.length&&e.resolve()}for(var e=new jQuery.Deferred,d=0,g=0;g<a.length;g++)w("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PARTIAL},{asin:a[g].asin}).then(b,e.reject);return e.promise()}function d(a){function b(){++e===a.length&&c.resolve()}for(var c=new jQuery.Deferred,
e=0,g=0;g<a.length;g++)D([a[g].asin]).then(b,c.reject);return c.promise()}function j(){E($.makeArray(e.objectStoreNames)).then(h.resolve,f)}function f(){KindleDebug.error("Error occured signing out");h.reject()}var h;if(window.indexedDB.deleteDatabase)return K();h=new jQuery.Deferred;e.name==="K4Wbooks"?$.when(E(["annotationsCache"]),E(["pageNumberCache"])).then(a,f):j();return h.promise()},getTableNames:b,insertRecord:function(a,b){return q(a,[b])},insertList:q,upsertRecord:function(a,b,c){return h(a,
function(a,e,d){a=a.objectStore(e);C(a,e,[b,c]).then(d.resolve,d.reject)},M)},updateRecord:w,getRecord:F,deleteRecord:function(a,b){return h(a,function(a,c,e){a=a.objectStore(c);I(a,c,[b]).then(e.resolve,e.reject)},M)},batchTransaction:function(a){if(!a||a.length===0){var b=new jQuery.Deferred;b.resolve([]);return b.promise()}var b=[],c=!0,e=[],j=0,f;for(f in a)$.inArray(a[f].tableName,b)===-1&&(d(a[f].tableName),b.push(a[f].tableName)),c&&a[f].operation!==Kindle.DB.GET_RECORD_OPERATION&&(c=!1);return h(b,
function(b,c,f){function h(b){return function(c){e[b]=c;++j===a.length?f.resolve(e):t()}}function r(){b.abort();f.reject()}function t(){(k=a[w])||f.reject();d(k.tableName);T[k.operation](b.objectStore(k.tableName),k.tableName,k.params).then(h(w),r);++w}var k,w=0;t();return f.promise()},c?P:M)},getPieceIds:function(a,b){d(a);return h(a,function(c,e,d){var f=[],h,c=c.objectStore(a),e=k({asin:b,id:0},a);h=k({asin:b,id:r},a);e=IDBKeyRange.bound(e,h);c=c.openCursor(e);c.onsuccess=function(a){var b;(a=
a.target.result)?(b=a.key.split(j),b=parseInt(b[1],10),f.push(b),a["continue"]()):d.resolve(f)};c.onerror=d.reject},P)},getOldBookList:function(a){return z(function(b){if(b.key!==a&&b.value.cacheState!==Kindle.BookInfo.CachedState.PINNED)return b.value})},dbGetBookStatistics:function(a){function c(a){h.reject(a)}function d(a){h.reject(a)}function j(a){w[a]={count:0,size:0};return function(b){(b=b.target.result)?(w[a].count++,w[a].size+=b.value.size,b["continue"]()):w.totalSize+=w[a].size}}var f=[];
$.each(b(),function(a,b){A[b]&&A[b].info.size&&f.push(b)});f.push("bookinfo");var h,t,w,l,m,v;h=new jQuery.Deferred;w={totalSize:0,cacheState:"",cachedSize:0};l=e.transaction(f,P);l.oncomplete=function(){h.resolve(w)};l.onerror=c;l.onabort=c;t=k({asin:a,id:0},f[0]);v=k({asin:a,id:r},f[0]);v=IDBKeyRange.bound(t,v);for(t=0;t<f.length-1;t++)w[f[t]]={count:0,size:0},m=l.objectStore(f[t]),m=m.openCursor(v),m.onsuccess=j(f[t]),m.onerror=d;m=l.objectStore("bookinfo");m=m.get(a);m.onsuccess=function(a){if(a=
a.target.result)w.cacheState=a.cacheState,w.cachedSize=a.cachedSize||0};m.onerror=d;return h.promise()},dbDeleteBooksData:D,getSearchIndexData:function(a){var b=$.Deferred(),c=KindleMetricsProfiler("retrieve db search index");F("searchIndex",{asin:a}).then(function(a){if(!a||!a.length)b.reject();else{var e={};a.forEach(function(a){e[a.component]=a.data});c.endTimer();c.log();b.resolve(e)}},b.reject);return b.promise()},putSearchIndexData:function(a,b){var c=$.Deferred(),e=KindleMetricsProfiler("save db search index"),
d=[];d.push({asin:a,component:"positions",data:b.positions});d.push({asin:a,component:"words",data:b.words});d.push({asin:a,component:"properties",data:b.properties});q("searchIndex",d).always(function(){e.endTimer();e.log();c.resolve(b)});return c.promise()},deleteJournalEntries:function(a){return h("journal",function(b,c,e){b=b.objectStore(c).openCursor();b.onsuccess=function(b){if(b=b.target.result){var c=b.value,d;for(d in a)if(c.type===a[d].type&&(c.guid||c.refEmId)===(a[d].guid||a[d].refEmId)&&
c.start===a[d].start&&c.end===a[d].end&&c.position===a[d].position&&c.modifiedTimestamp===a[d].modifiedTimestamp&&c.asin===a[d].asin){delete a[d];b["delete"]();break}b["continue"]()}else e.resolve()};b.onerror=e.reject},M)},addEventListener:N.addEventListener,removeEventListener:N.removeEventListener}}
function KindleSqlWrapper(a,f){function d(a){if(!z[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function b(a,b){var c=new jQuery.Deferred,d=[];y[b?"readTransaction":"transaction"](function(b){a(b,d)},function(a){c.reject(a)},function(){c.resolve(d)});return c.promise()}function c(){var a=[],b;for(b in z)a.push(b);return a}function k(a,b,c){var d=[],e,f;for(f in a)e=b[f],e!==void 0?a[f]&Kindle.DB.OBJECT_TYPE?d.push(JSON.stringify(e)):a[f]&Kindle.DB.BLOB_TYPE?
d.push(K(e)):d.push(e):c&&!(a[f]&Kindle.DB.AUTO_INCREMENT)&&d.push(null);return d}function m(a,b){var c="",d,e;for(e in a)if(d=b[e])if(c+=(c?" AND ":"")+e,d.hasOwnProperty(Kindle.DB.OPERATOR))switch(d[Kindle.DB.OPERATOR]){case Kindle.DB.NOT_EQUAL:c+=" != ?";break;case Kindle.DB.IN_ARRAY:c+=" IN (?";for(var f=1;f<d[Kindle.DB.VALUES].length;f++)c+=", ?";c+=")"}else c+=" = ?";return c}function l(a){var b="";a&Kindle.DB.TEXT_TYPE||a&Kindle.DB.OBJECT_TYPE||a&Kindle.DB.BLOB_TYPE?b+="TEXT ":a&Kindle.DB.AUTO_INCREMENT?
b+="INTEGER PRIMARY KEY AUTOINCREMENT ":a&Kindle.DB.NUMBER_TYPE&&(b+="INTEGER ");!(a&Kindle.DB.PRIMARY_KEY)&&!(a&Kindle.DB.ALLOW_NULL)&&(b+="NOT NULL ");return b}function o(a,b){var c="DELETE FROM "+a;b&&(c+=" WHERE "+m(z[a],b));return c+";"}function s(a,b,c){if(c===void 0)c="*";else{var d=z[a],e="",f;for(f in d)c[f]&&(e+=(e?", ":"")+f);c=e}c="SELECT "+c+" FROM "+a;b&&(c+=" WHERE "+m(z[a],b));return c+";"}function h(a,c){d(a);if($.isArray(c)){if(c.length===0)return(new jQuery.Deferred).resolve().promise()}else return(new jQuery.Deferred).reject().promise();
return b(function(b){u(b,a,[c])},!1)}function u(a,b,c,d,e){var c=c[0],f,d=z[b],e="INSERT OR "+(e?"IGNORE":"REPLACE")+" INTO "+b+" (",h="",w="";for(f in d)d[f]&Kindle.DB.AUTO_INCREMENT||(h+=(h?", ":"")+f,w+=(w?", ":"")+"?");e+=h+") VALUES ("+w+");";f=e;b=z[b];for(e=0;e<c.length;e++)d=k(b,c[e],!0),a.executeSql(f,d)}function q(a,b,c,d,e){var d=c[0],c=c[1],f=z[b],h=z[b],w="",l;for(l in h)d[l]!==void 0&&(w+=(w?", ":"")+l+" = ?");b="UPDATE "+(e?"OR IGNORE ":"")+b+" SET "+w;c&&(b+=" WHERE "+m(h,c));b+=";";
d=k(f,d);c&&(d=d.concat(k(f,c)));a.executeSql(b,d)}function n(a,b,c){q(a,b,c,[],!0);u(a,b,[[$.extend({},c[0],c[1])]],[],!0)}function v(a,b){var c={},d,e,f;for(f in a)if(d=b[f],d!==void 0&&d!==null){e=a[f];var h=c,k=f;if(e&Kindle.DB.OBJECT_TYPE)d=JSON.parse(d);else if(e&Kindle.DB.BLOB_TYPE){e=d;d=e.slice(1);e.charAt(0)==="x"&&(d=KindleO_Aaa.o_aag(d));e=new ArrayBuffer(d.length);for(var w=new Uint8Array(e),l=0;l<d.length;l++)w[l]=d.charCodeAt(l);d=e}h[k]=d}return c}function w(a,c,f){d(a);return b(function(b,
e){B(b,a,[c,f],e)},!0)}function C(a){var b=[],c;if(a)for(var d in a)c=a[d],c.hasOwnProperty(Kindle.DB.VALUES)?b=b.concat(c[Kindle.DB.VALUES]):b.push(c);return b}function B(a,b,c,d){var e=c[0],f=z[b];a.executeSql(s(b,e,c[1]),C(e),function(a,b){if(b.rows.length>0)for(var c=0;c<b.rows.length;c++)d.push(v(f,b.rows.item(c)))})}function F(a,b,c){c=c[0];a.executeSql(o(b,c),C(c))}function I(a){return b(function(b,c){for(var d,e=0;e<a.length;e++)if(d=D[a[e].operation])c[e]=[],d(b,a[e].tableName,a[e].params,
c[e])},!1)}function E(a){var b,c=[];for(b in a)c.push({operation:Kindle.DB.CREATE_TABLE_OPERATION,tableName:b,params:[a[b]]});return I(c)}function K(a){a=function(a){var b;b=a instanceof ArrayBuffer||Object.prototype.toString.call(a)==="[object ArrayBuffer]";if(!b)throw"[KindleSqlWrapper binaryToString] Unknown data type passed. Expect ArrayBuffer.";var c,e;if(KindleHostDeviceDetector.hasArrayLikeApply())try{var d=a.byteLength;b=d;for(c=[];b>=0;){var f=d-b,h=a.slice(f,Math.min(f+1E4,d));e=new Uint8Array(h);
c.push(String.fromCharCode.apply(null,e));b-=1E4}}catch(j){c=null}if(!c){c=[];e=new Uint8Array(a);for(a=0;a<e.length;a++)c.push(String.fromCharCode(e[a]))}return c.join("")}(a);return a.match(/\x00/g)?"x"+KindleO_Aaa.o_aaa(a):"t"+a}var y=null,z={},D={};D[Kindle.DB.INSERT_LIST_OPERATION]=u;D[Kindle.DB.UPDATE_RECORD_OPERATION]=q;D[Kindle.DB.UPSERT_RECORD_OPERATION]=n;D[Kindle.DB.DELETE_RECORD_OPERATION]=F;D[Kindle.DB.GET_RECORD_OPERATION]=B;D[Kindle.DB.CREATE_TABLE_OPERATION]=function(a,b,c){var c=
c[0],d="CREATE TABLE IF NOT EXISTS "+b+"(",e="",f,h=!0,k;for(k in c)h?h=!1:d+=", ",d+=k+" ",f=c[k],d+=l(f),f&Kindle.DB.PRIMARY_KEY&&(e+=e?", ":" PRIMARY KEY (",e+=k);e&&(d+=", "+e+")");d+=");";z[b]=c;a.executeSql(d,[])};D[Kindle.DB.ALTER_TABLE_OPERATION]=function(a,b,c){var d=z[b],e,f;e="";for(var h=0;h<c.length;h++)e=c[h],f=d[e]|Kindle.DB.ALLOW_NULL,e="ALTER TABLE "+b+" ADD COLUMN "+e+" ",e+=l(f),e+=";",a.executeSql(e,[])};return{createTables:function(){KindleDebug.error("Called deprecated createTables function")},
openDatabase:function(){var b=new jQuery.Deferred,c=a.defaultSize;f!==void 0&&c>f*1E6&&(c=_maxDbSize*1E6);try{y=openDatabase(a.shortName,"",a.displayName,c)}catch(d){try{y=openDatabase(a.shortName,"",a.displayName,5E6)}catch(h){return b.reject(h)}}var e=parseInt(y.version,10)||y.version;KindleHostDeviceDetector.isiOS_4x()||y.changeVersion(e,a.version);E(a.tables).done(function(){var c=a.versionUpdate,d=[];if(c&&c.length)for(var f=0;f<c.length;f++)c[f].version>e&&d.push({operation:c[f].operation,tableName:c[f].tableName,
params:c[f].params});I(d).then(b.resolve(y),b.reject)}).fail(b.reject);return b.promise()},dropTables:function(){return b(function(a){for(var b in z)a.executeSql("DROP TABLE IF EXISTS "+b+";")},!1)},getTableNames:c,insertRecord:function(a,b){return h(a,[b])},insertList:h,upsertRecord:function(a,c,f){d(a);return b(function(b){n(b,a,[c,f])},!1)},updateRecord:function(a,c,f){d(a);return b(function(b){q(b,a,[c,f])},!1)},getRecord:w,deleteRecord:function(a,c){d(a);return b(function(b){F(b,a,[c])},!1)},
batchTransaction:I,getPieceIds:function(a,b){var c=new jQuery.Deferred;w(a,{asin:b},{id:!0}).then(function(a){var b=[],d;for(d in a)b.push(a[d].id);c.resolve(b)},c.reject);return c.promise()},getOldBookList:function(a){var b=new jQuery.Deferred;w("bookinfo",{asin:{operator:Kindle.DB.NOT_EQUAL,values:[a]},cacheState:{operator:Kindle.DB.NOT_EQUAL,values:[Kindle.BookInfo.CachedState.PINNED]}},{asin:!0,openTime:!0}).then(function(a){a.length===0?b.reject():b.resolve(a)},b.reject);return b.promise()},
dbGetBookStatistics:function(a){var b=new jQuery.Deferred,d=[];$.each(c(),function(a,b){z[b]&&z[b].size&&d.push(b)});for(var f={totalSize:0,cacheState:"",cachedSize:0},e,h=[],k=0;k<d.length;k++)h.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:d[k],params:[{asin:a},{size:!0}]});h.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:"bookinfo",params:[{asin:a},{cacheState:!0,cachedSize:!0}]});I(h).then(function(a){for(var c=0;c<d.length;c++){var h=a[c],j=0,k=void 0;for(k in h)j+=h[k].size;
e={count:h.length,size:j};f[d[c]]=e;f.totalSize+=e.size}f.cacheState=a[a.length-1][0].cacheState;f.cachedSize=a[a.length-1][0].cachedSize||0;b.resolve(f)},function(){b.resolve(f)});return b.promise()},dbDeleteBooksData:function(a){var b,d,f,e=[];f=c();for(d=0;d<a.length;++d)for(b=0;b<f.length;++b)e.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:f[b],params:[{asin:a[d]}]});return I(e)},getSearchIndexData:function(a){var b=$.Deferred();w("searchIndex",{asin:a}).then(function(a){if(!a||
!a.length)b.reject();else{var c={},d={};a.forEach(function(a){c[a.component]=a.data});d.positions=c.positions;d.words=c.words;d.properties=c.properties;b.resolve(d)}},b.reject);return b.promise()},putSearchIndexData:function(a,b){var c=$.Deferred(),d=[];d.push({asin:a,component:"positions",data:b.positions});d.push({asin:a,component:"words",data:b.words});d.push({asin:a,component:"properties",data:b.properties});h("searchIndex",d).always(function(){c.resolve(b)});return c.promise()},deleteJournalEntries:function(a){var b=
[],c;for(c in a)b.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"journal",params:[{id:a[c].id}]});return I(b)}}}
function KindleStubDBWrapper(a){function f(a){if(!h[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function d(a,b){var c=b[0],d,k,l,m;for(m in c){d={};l=a;k=d;var o;o=l;var s=c[m];f(o);var n=h[o],D=!0,j=void 0,t=void 0;for(t in n.info)if(j=n.info[t],s[t])if(j&Kindle.DB.AUTO_INCREMENT)D=!1;else{switch(typeof s[t]){case "number":D=j&Kindle.DB.NUMBER_TYPE;break;case "string":D=j&Kindle.DB.TEXT_TYPE;break;case "object":D=j&Kindle.DB.OBJECT_TYPE}if(!D)break}else if(j&
Kindle.DB.AUTO_INCREMENT)q[o]++,s[t]=q[o];else if(!(j&Kindle.DB.ALLOW_NULL)||j&Kindle.DB.PRIMARY_KEY)D=!1;o=D?null:Kindle.DB.CONSTRAINT_ERR;D=n=s=void 0;if(o===null){D=h[l].keyList;n=u[l];for(l=0;l<D.length-1;l++)s=D[l],n[s]||(n[s]={}),n=n[k];k.container=n;k.key=D[D.length-1]}k=o;if(k===null)l=c[m][d.key],d.container[l]?k=Kindle.DB.CONSTRAINT_ERR:d.container[l]=c[m];else{k=Kindle.DB.CONSTRAINT_ERR;break}}return k}function b(a,b){var c=new jQuery.Deferred,f=d(a,[b]);f?c.reject(f):c.resolve();return c.promise()}
function c(a,b){f(a);var c=h[a].keyList,d=u[a],k,l,m={};for(k=0;k<c.length;k++)if(l=c[k],b[l])if(k===c.length-1){m.key=b[l];break}else d[b[l]]||(u[b[l]]={}),d=u[b[l]],delete b[l];else break;if(k<c.length-1)throw"unsupported use case for in-memory DB!!";m.container=d;m.selection=b;return m}function k(a,b){var d=b[0],f=null,h=c(a,b[1]);h.container&&h.key&&h.container[h.key]?$.extend(h.container[h.key],d):f=Kindle.DB.CONSTRAINT_ERR;return f}function m(a,b){$.extend(b[0],b[1]);var c=d(a,[[b[0]]]);c===
Kindle.DB.CONSTRAINT_ERR&&(c=k(a,b));return c}function l(a,b,d){var b=b[0],f=h[a],k=u[a],l,m;if(b){if(a=c(a,b),k=a.container)if(a.key)k[a.key]&&d.push(k[a.key]);else for(l in a=a.selection,f=!0,k){for(m in a)if(k[l][m]!==b[m]){f=!1;break}f&&d.push(k[l])}}else if(f.keyList.length!==1)throw"unsupported use case for in-memory DB!!";else for(l in k)d.push(k[l]);return null}function o(a,b){var d=b[0],f,h=u[a],k,l,m;if(d){if(f=c(a,d),h=f.container)if(f.key)delete h[f.key];else for(k in f=f.selection,m=
!0,h){for(l in f)if(h[k][l]!==d[l]){m=!1;break}m&&delete h[k]}}else u[a]={};return null}function s(a){var b=new jQuery.Deferred,c,d=[],f;for(f in a)if(c=a[f],d[f]=[],c=n[c.operation](c.tableName,c.params,d[f]))break;c===null?b.resolve(d):b.reject(c);return b.promise()}var h={},u={},q={},n={};n[Kindle.DB.INSERT_LIST_OPERATION]=d;n[Kindle.DB.UPDATE_RECORD_OPERATION]=k;n[Kindle.DB.UPSERT_RECORD_OPERATION]=m;n[Kindle.DB.DELETE_RECORD_OPERATION]=o;n[Kindle.DB.GET_RECORD_OPERATION]=l;n[Kindle.DB.CREATE_TABLE_OPERATION]=
function(a,b){var c=!0,d=!1,f,k=[],l=0,m=b[0],o;for(o in m)if(f=m[o],f&Kindle.DB.AUTO_INCREMENT||f&Kindle.DB.PRIMARY_KEY)d?c=!1:(d=f&Kindle.DB.AUTO_INCREMENT,k.push(o));if(c){if(k.length===0)k.push("id"),m.id=Kindle.DB.AUTO_INCREMENT,d=!0;h[a]={info:m,keyList:k};(f=u[a])||(u[a]={});if(d){for(var s in f)l=Math.max(l,parseInt(s,10));q[a]=l}}return c?null:Kindle.DB.CONSTRAINT_ERR};(function(){var b;try{b=JSON.parse(KindleLocalStorage.getItem(a))}catch(c){}b&&typeof b==="object"&&(u=b)})();return{persist:function(){var b=
null;try{KindleLocalStorage.setItem(a,JSON.stringify(u))}catch(c){b=Kindle.DB.QUOTA_ERR}return b},createTables:function(a){var b,c,d;b=new jQuery.Deferred;d=[];for(c in a)d.push({operation:Kindle.DB.CREATE_TABLE_OPERATION,tableName:c,params:[a[c]]});s(d).then(b.resolve,b.reject);return b.promise()},dropTables:function(){u={};h={};q={};KindleLocalStorage.setItem(a,null);return(new $.Deferred).resolve().promise()},getTableNames:function(){var a=[],b;for(b in h)a.push(b);return a},insertRecord:function(a,
c){return b(a,[c])},insertList:b,upsertRecord:function(a,b,c){var d=new jQuery.Deferred;(a=m(a,[b,c]))?d.reject(a):d.resolve();return d.promise()},updateRecord:function(a,b,c){var d=new jQuery.Deferred;(a=k(a,[b,c]))?d.reject(a):d.resolve();return d.promise()},getRecord:function(a,b){var c=new jQuery.Deferred,d=[],f=l(a,[b],d);f?c.reject(f):c.resolve(d);return c.promise()},deleteRecord:function(a,b){var c=new jQuery.Deferred,d=o(a,[b]);d?c.reject(d):c.resolve();return c.promise()},batchTransaction:s,
deleteJournalEntries:function(a){var b=[],c;for(c in a)b.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"journal",params:[{id:a[c].id}]});return s(b)}}}
var BookChunk=function(){var a=Object.freeze?function(a){return Object.freeze(a)}:function(a){return a},f=["fragment","glyph","skeleton","resource","locationMap"],d={};f.forEach(function(a){d[a]={}});d.resource.huge=!0;var b={types:a(f),properties:a(d),getId:function(a){if(a.fragmentMetadata!==void 0)return a.fragmentMetadata.id;else if(a.skeletonMetadata!==void 0)return a.skeletonMetadata.id;else if(a.glyphFragmentMetadata!==void 0)return a.glyphFragmentMetadata.id;else if(a.metadata!==void 0)return a.metadata.id;
else KindleAssert(!1,"Can't get id from book chunk: unrecognizable metadata.")}};f.forEach(function(a){b[a.toUpperCase()+"_TYPE"]=a});return a(b)}(),RemoteContentCache=function(){return{create:function(a){function f(a){m=a;if(!d||d.state!=="pending")d=$.Deferred();d.resolve(m)}var d=$.Deferred(),b=a.asin,c=a.contentProvider,k=a.contentRemover,m,l={};BookChunk.types.forEach(function(a){l[a]={getChunks:function(d,f,k){c("getChunks",b,a,d).then(f,k)},putChunks:function(d,f,k){var l={};d.forEach(function(a,
b){l[b]=a});c("putChunks",b,a,l).then(f,k)},getCachedIds:function(d,f){c("getChunkIds",b,a).then(d,f)}}});l.queryBookinfo=function(){return c("getBookinfo",b).pipe(function(a){f(a);return a})};l.getBookinfo=function(){return d.promise()};l.putBookinfo=function(a){f(a);return c("putBookinfo",b,a)};l.updateBookinfo=function(a){if(!m)return $.Deferred().reject("bad state");$.extend(m,a);return c("updateBookinfo",b,a)};l.getAnnotations=function(){return c("getAnnotations",b)};l.putAnnotations=function(a){return c("putAnnotations",
b,a)};l.getPageNumbers=function(){return c("getPageNumbers",b)};l.putPageNumbers=function(a){return c("putPageNumbers",b,a)};l.computeQuota=function(){return $.Deferred().resolve(0)};l.getBookStatistics=function(){return $.Deferred().reject()};l.checkCache=function(){return!0};l.deleteOldestBook=function(a,b){b()};l.deleteBooksData=function(){m=void 0;d.state()!=="pending"&&(d=$.Deferred());return k({asin:b})};l.downloadSearchIndex=function(a){return c("getSearchIndexReader",b,a)};l.initMetadata=
function(a){return c("initMetadata",b,a)};return l}}}(),ContentMigration=function(){function a(a){function b(d){var f="get"+(d.substr(0,1).toUpperCase()+d.substr(1))+"Ids";return a.source[f]().pipe(function(b){function f(){var m=b.splice(0,100);if(m.length===0)k.then(l.resolve,l.reject);else{var o="get"+(d.substr(0,1).toUpperCase()+d.substr(1))+"s",m=a.source[o](m);$.when(m,k).then(function(b){var l={};b.forEach(function(a,b){l[b]=a});k=a.target("putChunksNonT",a.asin,d,l);setTimeout(f,100)},l.reject)}}
var k=$.Deferred().resolve(),l=$.Deferred();f();return l.promise()})}function d(){var a=BookChunk.types[o++];a?b(a).then(d,f.reject):f.resolve()}var f=$.Deferred(),o=0,s=a.timer.createSubTimer("chunks");d();f.done(function(){s.endTimer()});return f.promise()}function f(a){var b=$.Deferred(),d=a.timer.createSubTimer("annotations");a.source.getAnnotations().then(function(d){a.target("putAnnotations",a.asin,d).then(b.resolve,b.reject)},b.reject);b.done(function(){d.endTimer()});return b.promise()}function d(a){var b=
$.Deferred(),d=a.timer.createSubTimer("pageNumbers");a.source.getPageNumbers().then(function(d){a.target("putPageNumbers",a.asin,d).then(b.resolve,b.reject)},b.reject);b.done(function(){d.endTimer()});return b.promise()}function b(a){var b=$.Deferred(),d=a.timer.createSubTimer("bookinfo");a.source.getBookInfo().then(function(d){a.target("putBookinfo",a.asin,d).then(b.resolve,b.reject)},b.reject);b.done(function(){d.endTimer()});return b.promise()}return{initialize:function(){KindleModuleManager.define(KindleModuleManager.CONTENT_MIGRATION,
[Kindle.MODULE.DB_CLIENT,KindleModuleManager.EMBEDDED_HOSTINTERFACE],function(c,k){return{moveBook:function(m){var l=$.Deferred(),o=c.getBookDb();if(!m)return l.reject("Need ASIN as param").promise();var s={timer:KindleMetricsProfiler("Migrate "+m),asin:m,target:k.contentProvider,source:o.BookInfoDB(m)},m=$.when(a(s),f(s),d(s),b(s));m.then(function(){s.timer.endTimer();s.timer.log()});m.then(l.resolve,l.reject);return l.promise()},notifyMigrationStatus:function(a){var b=$.Deferred();if(!a||!a.status)return b.reject("Need param.status as param").promise();
a.status==="done"?c.getBookDb().dropTables().then(b.resolve,b.reject):b.reject("this status is not handled");return b.promise()}}})}}}();function AssertionError(a){Error.call(this,a)}AssertionError.prototype=Error();AssertionError.prototype.name="AssertionError";function KindleAssert(){}
var KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleDeviceCapabilities=function(){function a(){return KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?!0:!1}var f;return{searchInTheBook:function(){return!KindleHostDeviceDetector.isiOS_4x()},showPageNumbers:function(){return!KindleHostDeviceDetector.isiOS_4x()},multiColumnMode:function(){return!0},useNativeSelection:a,useCSSRegions:function(){return a()},
useLocaleCompare:function(){if(f===void 0){try{"a".localeCompare("b","i")}catch(a){return f=a.name==="RangeError"}f=!1}return f},showFirstRunDialog:function(){return!KindleHostDeviceDetector.isMSEdge()},hasPageResizeIssues:function(){return KindleHostDeviceDetector.isiOS_9x()?!0:!1},hasSplitView:function(){return KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.getOSMajorVersion()>=9}}}(),KindleHostDeviceDetector=function(){function a(){return navigator.platform.indexOf("iPad")!==-1}function f(){return navigator.platform.indexOf("iPhone")!==
-1||navigator.platform.indexOf("iPod")!==-1}function d(){return a()||f()||s()}function b(){var a=-1;d()&&(a=navigator.userAgent.match(/OS (\d+)_/)[1]);return a}function c(){return(a()||f())&&parseInt(b(),10)===7}function k(){return(a()||f())&&parseInt(b(),10)>=8}function m(){return(a()||f())&&parseInt(b(),10)>=9}function l(){return navigator.userAgent.indexOf("Firefox")!==-1&&navigator.userAgent.indexOf("Trident")<0}function o(a){var b=navigator.userAgent.match(/Version\/(\d+\.\d+)(?:\.\d+)*(?: Mobile\/\S+)? Safari/);
return!b?!1:!a?!0:Number(b[1])>=Number(a)}function s(){return navigator.userAgent.indexOf("Cloud9")!==-1}function h(){return navigator.userAgent.indexOf("MSAppHost")!==-1}function u(){return h()&&q()}function q(){return!!/arm/i.test(navigator.cpuClass)}function n(){return l()?navigator.onLine:KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()}function v(){return navigator.userAgent.indexOf("MSIE")!==-1||navigator.userAgent.indexOf("Trident")!==-1}function w(){return navigator.userAgent.indexOf("Chrome")!==
-1&&navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Edge")!==-1}function C(){return"standalone"in navigator&&navigator.standalone}function B(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function F(){return window.navigator.msMaxTouchPoints>=1}return{isiOS:d,isiPad:a,isiPhone:f,isiOS_4x:function(){return(a()||f())&&navigator.userAgent.indexOf("OS 4")!==-1},isiOS_5xOrGreater:function(){return(a()||f())&&parseInt(b(),10)>=5},isiOS_7x:c,isiOS_8x:k,
isiOS_9x:m,hasiOSInnerHeightBug:function(){return!m()&&(c()||k())},hasCanvasSizeLimitProblem:function(){return d()},isMacintosh:function(){return navigator.userAgent.indexOf("(Macintosh;")!==-1},isFirefox:l,hasHangingDbPrompt:function(){if(!l())return!1;var a=/Firefox\/(\d+)/.exec(navigator.userAgent);return a.length>=1&&a[1]>=17},isSafari:o,isMetro:h,isMetroArm:u,isMetroSnappedView:function(){return h()&&window.outerWidth===320},isIE:v,isIE10:function(){return v()&&navigator.userAgent.indexOf("Trident/6.0")!==
-1},isIE11:function(){return v()&&(navigator.userAgent.indexOf("Trident/7.0")!==-1||navigator.userAgent.indexOf("Trident/8.0")!==-1)},isMSEdge:w,isArm:q,isCloud9:s,isTablet:function(){return a()||h()},isOnline:n,isNetworkAvailable:function(){if(!n())return(new jQuery.Deferred).reject().promise();var a=$.Deferred();$.ajax({url:"/ping",error:function(){a.reject()},timeout:5E3}).then(a.resolve,a.reject);return a.promise()},isNetworkAvailableSync:function(){if(!n())return!1;var a=!0;$.ajax({url:"/ping",
error:function(){a=!1},timeout:50,async:!1});return a},isChrome:function(){return window.chrome&&!w()},isiOSAppMode:C,isChromeApp:B,isFirefoxAppSupported:function(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps},isInAppMode:function(){return C()||B()},isCookieEnabled:function(){return navigator.cookieEnabled},areWebWorkersSupported:function(){return typeof Worker!=="undefined"},isLocalStorageEnabled:function(){return KindleLocalStorage.isLocalStorageEnabled()},hasArrayLikeApply:function(){return!d()||
parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)>=6},isWebSQLSupported:function(){return!!window.openDatabase},isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.indexedDB},isMSTouchEnabledDevice:F,isTouchDevice:function(){return d()||F()},getDevicePlatform:function(){return a()?"iPad":f()?"iPhone":s()?"otter":u()?"metroArm":h()?"metro":"desktop"},hasCanvasPerformanceProblem:function(){return a()&&KindleHostPadDetector.isPad1(C())||u()},hasMissingImgOnLoadProblem:function(){return o()||
C()||l()},hasImageRenderingProblem:function(){return o()||C()},getDeviceType:function(){return h()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR},getClientName:function(){return h()?Kindle.ClientName.Metro:Kindle.ClientName.KCR},getOSMajorVersion:b,getOSMinorVersion:function(){var a=-1;d()&&(a=navigator.userAgent.match(/OS (\d+)_(\d+_?(\d+)?)/)[2]);return a},getBrowserLanguage:function(){return navigator.language||navigator.userLanguage}}}(),KindleHostPadDetector=function(){return{isPad1:function(a){if(KindleLocalStorage.getItem("definitelyNotPad1"))return!1;
var f=0,d=1E3,b=0,c;for(i=0;i<3;i++)c=SunSpiderBenchmark.get3DSpeed(),c>f?f=c:c<d&&(d=c),b+=c;f=b/3;if(f>=200&&a)return!0;if(f>=100&&!a)return!0;KindleLocalStorage.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function a(a,d){for(var b in d)if(d.hasOwnProperty(b)&&typeof a[b]!==typeof d[b])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){},setToolbarVisible:function(){},downloadBook:function(){},removeBook:function(){}},
IKindleAppForLibrary:{storeIsTOS:function(){},openStore:function(){},openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openStore:function(){},pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){}},checkImplements:a,assertImplements:function(f,d){a(f,d)||KindleAssert(!1,"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function a(a){var b=[],c;for(c in a){var d=a[c].entry;d.guid=d.guid||d.refEmId;delete d.refEmId;d&&b.push(d)}return b}function f(a){var b=[],d;for(d in a)b.push({entry:a[d]});return k.getAppDb().getTable(c).insertList(b)}function d(b){function c(){var q,n=KindleModuleManager.getModuleSync(KindleModuleManager.RESOURCE_BUNDLE).getLocalTimeOffset();f<b.length?(u=Math.min(f+100,b.length),q=Array.prototype.slice.call(b,f,u),
f=u,m.updateAnnotations(a(q),n).then(function(){k.getAppDb().deleteJournalEntries(q).then(c,d.reject)},d.reject)):d.resolve()}var d=new jQuery.Deferred,f=0,u;c();return d.promise()}function b(){var a=new jQuery.Deferred;k.getAppDb().getTable(c).getRecord().then(function(b){b.length>0?d(b).then(a.resolve,a.reject):a.resolve()},a.reject);return a.promise()}var c="journal",k=null,m=null;return{initialize:function(){var a=new jQuery.Deferred,b=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,
KindleModuleManager.DB_CLIENT]).then(function(c){m=c[KindleModuleManager.SERVICE_CLIENT];k=c[KindleModuleManager.DB_CLIENT];a.resolve(b)},a.reject);return a.promise()},saveToJournal:function(a){var c=new jQuery.Deferred;f(a).then(function(){b().then(c.resolve,c.resolve)},c.reject);return c.promise()},uploadJournal:b}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return KindleLocalStorage.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return KindleLocalStorage.getItem("kindleDeviceToken")},
setDeviceToken:function(a){KindleLocalStorage.setItem("kindleDeviceToken",a)},clearDeviceTokenFromStorage:function(){KindleLocalStorage.removeItem("kindleDeviceToken")}}}(),KindleMetricsProfiler=function(a){function f(a){for(var c=0,d=0;d<a.length;d+=1)c+=a[d].end-a[d].start;return c}var d={};d.name=a;d.counters=null;d.subTimers=null;d.runs=[{start:(new Date).getTime(),end:null}];d.endTimer=function(){var a=this.runs[this.runs.length-1];if(a.end===null)a.end=(new Date).getTime()};d.addCount=function(a,
c){if(this.counters===null)this.counters={};this.counters[a]===void 0?this.counters[a]=c:this.counters[a]+=c};d.createSubTimer=function(a){if(this.subTimers===null)this.subTimers={};this.subTimers[a]===void 0?this.subTimers[a]=KindleMetricsProfiler(a):this.subTimers[a].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[a]};d.log=function(){this.logAsPercentageOfTime("",f(this.runs))};d.logAsPercentageOfTime=function(a,c){var d=a+":"+this.name,m,l=f(this.runs);KindleDebug.log(d+
":Time: "+l+"ms - ("+(c?l/c*100:100).toFixed(2)+"%)");for(m in this.counters)KindleDebug.log(d+":"+m+" : "+this.counters[m]);for(m in this.subTimers)this.subTimers[m].logAsPercentageOfTime(d,c)};return d};
function KindleModuleManagerFactory(){function a(a,b){if(n[a])throw"Duplicate registration of module "+a;if(!b)throw"Module is not initialized with an object "+a;n[a]=b;v[a].resolve(b)}function f(a){if(n.hasOwnProperty(a))throw"Duplicate registration of module "+a;n[a]=void 0}function d(b,c){v[b]||(v[b]=new jQuery.Deferred);a(b,c)}function b(b,c){f(b);v[b]||(v[b]=new jQuery.Deferred);c(v[b]);v[b].done(function(c){a(b,c)})}function c(a,c){b(a,function(a){c.done(a.resolve).fail(a.reject)})}function k(a){v[a]||
(v[a]=new jQuery.Deferred);return v[a].promise()}function m(a){if(!n[a])throw"Trying to get uninitialized module "+a;return n[a]}function l(a){return n.hasOwnProperty(a)}function o(a,b){n[a]=b}function s(a){var b=n[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function h(a){for(var b={},c=0;c<a.length;c++)b[name]=n[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function u(){n={}}var q={CONSTANTS:"Constants",DB_CLIENT:"DBClient",RESOURCE_BUNDLE:"ResourceBundle",
METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap",EMBEDDED_HOSTINTERFACE:"embeddedHostInterface",CONTENT_MIGRATION:"contentMigration",NETWORK:"network",LINK_URLS:"linkUrls"},n={},v={};return{CONSTANTS:q.CONSTANTS,DB_CLIENT:q.DB_CLIENT,RESOURCE_BUNDLE:q.RESOURCE_BUNDLE,METRICS_MANAGER:q.METRICS_MANAGER,SERVICE_CLIENT:q.SERVICE_CLIENT,APP_REGISTRATION:q.APP_REGISTRATION,
JOURNAL_MANAGER:q.JOURNAL_MANAGER,BOOK_METADATA:q.BOOK_METADATA,BOOK_FRAGMAP:q.BOOK_FRAGMAP,EMBEDDED_HOSTINTERFACE:q.EMBEDDED_HOSTINTERFACE,CONTENT_MIGRATION:q.CONTENT_MIGRATION,NETWORK:q.NETWORK,LINK_URLS:q.LINK_URLS,ERROR_CODE_CANCEL:"canceled",registerModule:d,registerModuleList:function(a){for(var b in a)d(b,a[b])},registerModuleWithInitializer:b,registerModuleWithDeferred:c,detachModule:function(a){var b=n[a],c=v[a];c&&!c.isResolved()&&c.reject("canceled");delete n[a];delete v[a];return b},getModule:k,
getModuleList:function(a){var b=new jQuery.Deferred,c,d=[];for(c=0;c<a.length;c++)d.push(k(a[c]));$.when.apply($,d).done(function(){var c,d={};for(c=0;c<a.length;c++)d[a[c]]=arguments[c];b.resolve(d)}).fail(b.reject);return b.promise()},getModuleSync:m,isModuleInitialized:function(a){return n[a]!==void 0},isModuleRegistered:l,switchToTestMode:function(){this.registerModuleTest=o;this.getModule=s;this.getModuleSync=m;this.getModuleList=h;this.clear=u;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer},
define:function(a,b,d){if(!l(a)){var f=[],h=$.Deferred();c(a,h);b&&b.length&&b.forEach(function(a){f.push(a&&$.isFunction(a.promise)?a:k(a))});$.when.apply($,f).then(function(){var a;typeof d==="function"?(a=$.makeArray(arguments),a=d.apply(d,a)):a=d;a&&$.isFunction(a.promise)?a.then(h.resolve,function(){h.reject()}):h.resolve(a)},function(){h.reject()})}},require:function(a,b){$.isArray(a)||(a=[a]);var c,d,f=[];a.forEach(function(a){f.push(a&&$.isFunction(a.promise)?a:k(a))});b||(d=$.Deferred(),
c=d.promise());$.when.apply($,f).then(function(){var a=$.makeArray(arguments);b?b.apply(b,a):d.resolve.apply(d,a)},function(){d&&d.reject()});return c}}}
var KindleModuleManager=KindleModuleManagerFactory(),KindleRemoteClient=function(){return{uploadFeedback:function(a){if(!a)return(new $.Deferred.reject).promise();var f=KindleLibrarySetting.getSettings(),f={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth,AppCached:!!KindleLocalStorage.getItem("cached"),AppCacheStatus:window.applicationCache.status,TouchEnabled:KindleHostDeviceDetector.isTouchDevice(),
ApplicationMode:KindleHostDeviceDetector.isInAppMode(),Language:navigator.language,LocalStorageEnabled:KindleHostDeviceDetector.isLocalStorageEnabled(),LibrarySort:f.sortParam,LibraryView:f.viewState,TLD:Kindle.URL.getAmazonDomain()||"unknown"};return function(a){return KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).pipe(function(b){try{var c=b.getAppDb(),f=c.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED),m=c.getAllBooks();a.info.OfflineStorageEnabled=!!b.bookDbEnabled();
return $.when(f,m)}catch(l){return $.Deferred.reject()}}).pipe(function(b,c){$.extend(a.info,{TotalBookCount:c.length,TotalBookDownloaded:b.length});return a.eid?a.eid:KindleModuleManager.getModuleSync(Kindle.MODULE.SERVICE_CLIENT).getEID()}).pipe(function(b){a.eid=b;return a},function(){return $.Deferred().resolve(a)})}({version:KindleVersion.getVersionString(),message:a.text,deviceType:KindleHostDeviceDetector.getDeviceType(),info:f}).pipe(function(a){a={url:"/remote/feedback",type:"POST",processData:!1,
contentType:"application/json",data:JSON.stringify(a)};return $.ajax(a)})}}}(),KindleTemplateManager=function(){return{initialize:function(){Handlebars.registerHelper("str",function(a){return ResourceBundle.getLocalizedString(a)})}}}(),KindleUserAgentMetricsInfo=function(){function a(){function a(){var b=/MSAppHost\/([0-9\.]+)/.exec(navigator.userAgent);if(b)return b[1]}var b;if(!(b=function(){var a;if(["ipad","iphone"].indexOf(d)!==-1&&(d="ios",(a=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&
a.length>=2))return a[1]}())){var c;KindleHostDeviceDetector.isIE()&&(c=KindleHostDeviceDetector.isIE10()?"10":KindleHostDeviceDetector.isIE11()?"11":"unknown");b=c||a()||GoogleUserAgent.browserVersionString.toLowerCase()}return b}var f,d,b,c,k,m={chrome:14,firefox:7,safari:5,metro:1,ie:10,ios:4};return{browserWithVersionString:function(){if(!f){d=GoogleUserAgent.browserName.toLowerCase();b=a();a:{if(b){var l=/^0*([0-9]+)/.exec(b);if(l&&l.length>=2){c=parseInt(l[1],10);break a}else KindleDebug.error("Bad regex on versionString: "+
b)}c=void 0}k="undefined"===typeof c?"other":m[d]?[d,c].join("@"):"other";f=!0}return k}}}(),KindleVersion=function(){var a="011100302";window.location.hostname==="k4w-dev.aka.amazon.com"&&(a="999999998");if(a.length!==9)throw{name:"BadVersion",message:"bad version number. got: "+a};var f=null,d=null;return{getMetricsVersionString:function(){d||(d=parseInt(a.slice(0,2),10),d+=".",d+=parseInt(a.slice(2,4),10),d+=".",d+=parseInt(a.slice(4,6),10));return d},getVersionString:function(){f||(f=parseInt(a.slice(0,
2),10),f+=".",f+=parseInt(a.slice(2,4),10),f+=".",f+=parseInt(a.slice(4,6),10),f+=".",f+=parseInt(a.slice(6),10));return f},getVersionNumber:function(){return Number(a)},parseVersionString:function(a){return a&&(a=/(\d{1,2})\.(\d{1,2})\.(\d{1,2})\.(\d{1,3})/.exec(a))?Number(a[1])*1E7+Number(a[2])*1E5+Number(a[3])*1E3+Number(a[4]):NaN}}}(),LinkUrls=function(){function a(){b||(Kindle.URL.isPreProd()?(d=(d=Kindle.URL.getPreProdCountryCode())?d:"us",b=Kindle.CountryToDomainMap[d]):(b=Kindle.URL.getAmazonDomain(),
d=Kindle.DomainToCountryMap[b]))}function f(a){return $.Deferred().resolve(function(){var b;b=c+Kindle.CountryToDomainMap.us+k;b+="?"+l.DeviceType+"="+Kindle.DeviceType.KCR+"&"+l.Eid+"="+(s||"")+"&"+l.Method+"="+a;return b}())}var d,b,c="https://www.",k="/gp/kindle/kcp/links",m={Help:{NodeId:"200701430"},OfflineReading:{NodeId:"201255020"},IncreaseOfflineStorage:{NodeId:"201265520"},TroubleShooting:{NodeId:"200732370"},License:{NodeId:"200701450",RefTag:"kcr_legalnotices_menu"},KCPLanding:{DocId:{us:"1000493771",
uk:"1000425503",de:"1000482783",fr:"1000538763",it:"1000576423",es:"1000576363",jp:"3077089376",au:"3077705566",cn:"98968","in":"1000659093",ca:"1000817631",br:"1000828031",mx:"1001216041"},iTunesURL:"https://itunes.apple.com/",iTunesEndPoint:"/app/apple-store/id302584613?mt=8",DesktopEndpoint:"/gp/feature.html",DesktopQueryParam:"?ie=UTF8&docId="}},l={DeviceType:"deviceType",Eid:"eid",Method:"method",Asin:"a"},o={Help:"Help",Legal:"License",Terms:"TermsCond",Store:"StoreFront",Privacy:"Privacy",
DetailPage:"DetailPage"},s;return{getStoreUrl:function(d){if(s&&!d.kcrFree)return f(o.Store).pipe(function(a){d.tag&&(a+="&tag="+d.tag);d.refTag&&(a+="&ref_="+d.refTag);return a});else{a();var k=c+b+"?ref_="+d.refTag;d.tag&&(k+="&tag="+d.tag+"&at="+d.tag);return $.Deferred().resolve(k)}},getPrivacyUrl:function(){a();return c+b+"/privacy"},getTermsOfUseUrl:function(){return"http://www.kindle.com/support/terms"},getLegalUrl:function(){a();return c+b+"/gp/help/customer/display.html?nodeId="+m.License.NodeId+
"ref="+m.License.RefTag},getHelpUrl:function(){a();return c+b+"/gp/help/customer/display.html?nodeId="+m.Help.NodeId},getOfflineReadingUrl:function(){a();return c+b+"/gp/help/customer/display.html?nodeId="+m.OfflineReading.NodeId},getIncreaseOfflineStorageUrl:function(){a();return c+b+"/gp/help/customer/display.html?nodeId="+m.IncreaseOfflineStorage.NodeId},getTroubleShootingUrl:function(){a();return c+b+"/gp/help/customer/display.html?nodeId="+m.TroubleShooting.NodeId},getDetailPage:function(d){if(s&&
!d.kcrFree)return f(o.DetailPage).pipe(function(a){a+="&"+l.Asin+"="+d.asin;d.tag&&(a+="&tag="+d.tag);d.refTag&&(a+="&ref_="+d.refTag);return a});else{a();var k=c+b+"/dp/"+d.asin+("?ref_="+(d.refTag||Kindle.RefTag.Values.StoreSample));d.tag&&(k+="&tag="+d.tag+"&at="+d.tag);return $.Deferred().resolve(k)}},getKCPLandingPageLink:function(f){(!b||!d)&&a();var k;KindleHostDeviceDetector.isiPad()?k=m.KCPLanding.iTunesURL+d+m.KCPLanding.iTunesEndPoint:(k=c+b+m.KCPLanding.DesktopEndpoint,k=f?k+"/ref="+f:
k,k+=m.KCPLanding.DesktopQueryParam+m.KCPLanding.DocId[d]);return k},getDownloadLink:function(f){(!b||!d)&&a();var k=c+b+"/gp/kindle/kcpApp.html";return f?k+"/ref="+f:k},getAmazonDomainURL:function(){(!b||!d)&&a();return c+b},getRTEServiceURL:function(){(!b||!d)&&a();if(Kindle.URL.isPreProd()){var c="https://kindlestore-preprod";if(d==="it"||d==="es"||d==="in")c+="-eux";return c+"."+b+"/gp/digital/fiona/ajax/send-email-or-sms.html"}return this.getAmazonDomainURL()+"/gp/digital/fiona/ajax/send-email-or-sms.html"},
initializeEid:function(a){s=a}}}(),KindleChromeInstaller=function(){function a(){function a(){window.location.reload(!1)}Kindle.top.chrome.webstore.install(void 0,function(){KindleDebug.log("install success");setTimeout(a,250)},function(a){KindleDebug.error(a)})}function f(){return window.chrome&&Kindle.top.chrome.webstore&&Kindle.top.chrome.webstore.install}return{install:function(){f()?window.parent.document.getElementById("inlineInstallProxy").click():KindleMessageDialog.showError(Kindle.ERROR.OUTDATED_CHROME)},
initialize:function(){if(KindleHostDeviceDetector.isChrome()&&f()){var d=document.createElement("button");d.id="inlineInstallProxy";d.style.display="none";$(d).click(a);$("body").append(d)}}}}(),KindleFirefoxInstaller=function(){function a(){return Kindle.URL.getHostURL()+"/offline/kcr_ff.webapp"}function f(){if(!KindleHostDeviceDetector.isFirefoxAppSupported())return $.Deferred().reject().promise();var d=$.Deferred(),b=navigator.mozApps.getInstalled();b.onsuccess=function(){var c=!1,f=a();b.result.forEach(function(a){a.manifestURL===
f&&(c=!0)});d.resolve(c)};b.onerror=function(){KindleDebug.error("Error checking installation status: "+this.error.message);d.reject()};return d.promise()}return{install:function(){var d=$.Deferred();f().done(function(b){b?d.reject():(b=navigator.mozApps.install(a()),b.onsuccess=function(){KindleDebug.log("Firefox App successfully installed.");d.resolve()},b.onerror=function(){KindleDebug.error("Firefox App failed to install.");d.reject()})}).fail(d.reject);return d.promise()}}}();
EmbeddedReaderAPI={setLoginParameters:function(){},setFocusToReader:function(){},showAppbar:function(){},hideAppbar:function(){},toggleAppbar:function(){},sendMetrics:function(){},sendMetricsNow:function(){},deregister:function(){},clearDatabases:function(){},clearLocalStorage:function(){},openBook:function(){},goTo:function(){},downloadBook:function(){},requestDownloadedBookList:function(){},cancelBookDownload:function(){},removeBook:function(){},removeBookOwnership:function(){},getSearchContext:function(){},
requestOemAssociateId:function(){},getTodoItems:function(){},removeTodoItems:function(){},uploadSnapshot:function(){},getSearchIndex:function(){},getDownloadedBookInfo:function(){},requestDeviceName:function(){},getSelectedText:function(){},hideContextMenu:function(){},setStoreCookies:function(){},setServiceHost:function(){},uploadJournal:function(){},getTOSParams:function(){},moveAsinToHost:function(){},notifyMigrationStatus:function(){},updateAppCache:function(){},convertPositions:function(){},
updateAnnotations:function(){}};
ReaderHostAPI={onReaderLoaded:function(){},onAppCacheStatus:function(){},onAppCacheUpdateReady:function(){},onBookOpenStatus:function(){},onBookClose:function(){},onOpenStore:function(){},onServiceAuthState:function(){},pinBookToStart:function(){},onBookDownloadComplete:function(){},onBookDownloadFailed:function(){},onBookDownloadProgress:function(){},onDeregister:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){},showWebPage:function(){},getRequestSigningHeaders:$.rpc.fn(),
contentProvider:$.rpc.fn({timeout:9E4}),deleteBookContent:$.rpc.fn(),searchContent:function(){},showAnnotations:function(){}};function ReaderHostInterfaceFactory(a,f){KindleInterfaces.assertImplements(a,EmbeddedReaderAPI);return $.rpc({name:"KCR",iRemote:ReaderHostAPI,local:a,channelId:"reader",target:window.parent,remoteDomain:f})};
